function Settings(){var e=JSON.parse(localStorage.settings||"{}");this.language=e.language||autoDetectedLanguageByServer,this.enableTranslationTool=e.enableTranslationTool||!1,this.quality=e.quality||"hd720",this.announceTimeout=e.announceTimeout||3e3,this.send_new_follower_email=settingsFromServer.send_new_follower_email,this.send_new_subscriber_email=settingsFromServer.send_new_subscriber_email,this.flattr_automatically=settingsFromServer.flattr_automatically,this.lastfm_scrobble_automatically=settingsFromServer.lastfm_scrobble_automatically,this.save=function(){localStorage.settings=JSON.stringify({language:this.language,enableTranslationTool:this.enableTranslationTool,quality:this.quality,announceTimeout:this.announceTimeout}),UserManager.isLoggedIn()&&(LoadingBar.show(),params={flattr_automatically:this.flattr_automatically,lastfm_scrobble_automatically:this.lastfm_scrobble_automatically,send_new_follower_email:this.send_new_follower_email,send_new_subscriber_email:this.send_new_subscriber_email},$.post("/me/settings",params,function(e){LoadingBar.hide()}))}}function registerDropCallback(e){dropCallbacks.push(e)}function removeTargetClasses(){$(".target").removeClass("target"),$(".insert-before").removeClass("insert-before"),$(".insert-after").removeClass("insert-after"),$(".alert").removeClass("alert")}function dragAborted(){dragElem&&(dragElem.remove(),dragElem=null),removeTargetClasses(),sourceElem.removeClass("dragged")}function dragStarted(e){sourceElem=findDraggable($(e.target)),sourceElem.addClass("dragged");var t="";if(sourceElem.find(".title").length){var n=sourceElem.find(".title").not(sourceElem.find(".alternative > .title")),r=0;$.each(n,function(e,n){e<=2?t+='<span class="track">'+$(n).text()+"</span>":r+=1}),r&&(t+='<span class="overflow">'+TranslationSystem.get("+ $nbr more",{$nbr:r})+"</span>")}else t='<span class="track">'+sourceElem.text()+"</span>";dragElem=$('<span id="dragElem" />').html(t).appendTo("body")}function dragEnded(e){var t=findDroppable($(e.target)),n;if(t)for(n=0;n<dropCallbacks.length;n+=1)dropCallbacks[n](dragElem,sourceElem,t);removeTargetClasses(),sourceElem.removeClass("dragged"),dragElem.remove(),dragElem=null}function findDroppable(e){var t;return e.hasClass("droppable")?t=e:(t=e.parents(".droppable"),t&&(t=$(t[0]))),t}function findDraggable(e){var t;return e.hasClass("draggable")?t=e:(t=e.parents(".draggable"),t&&(t=$(t[0]))),t.hasClass("selected")?t=t.parent().children(".selected"):t.data("model").listViewSelect(),t}function mouseDragged(e){var t=$(e.target),n=findDroppable(t);dragElem.css({top:e.pageY,left:e.pageX+10}),removeTargetClasses(),mouseDraggedCallback&&mouseDraggedCallback(n,sourceElem),n&&(n.hasClass("playlists")&&n.find(".tracklist.active .video:last").addClass("insert-after"),sourceElem.data("type")!==undefined?n.data("type")!==sourceElem.data("type")&&n.addClass("target"):n.addClass("target"),n.hasClass("reorderable")&&typeof n.data("model")==typeof sourceElem.data("model")&&n.addClass("insert-before"))}function showContextMenu(e,t,n){var r=$('<ul id="contextmenu" />');$.each(e,function(e,t){var n=$('<li class="option" />').text(t.title).data("args",t.args).data("callback",t.callback).click(function(){$(this).data("callback")($(this).data("args")),$("#context-menu-blocker, #contextmenu").remove()});t.cssClass&&n.addClass(t.cssClass),n.appendTo(r)});var i=$('<div id="context-menu-blocker" class="blocker"></div>').mousedown(function(e){$("#context-menu-blocker, #contextmenu").remove(),e.stopPropagation()});i.appendTo("body"),r.appendTo("body"),n+r.height()>$(window).height()&&(n-=r.height()),t+r.width()>$(window).width()&&(t-=r.width()),r.css({top:n,left:t}),$("#context-menu-blocker, #contextmenu, #contextmenu li.option").bind("contextmenu",function(e){e.preventDefault()})}function showPlaylistContextMenu(e,t){t.preventDefault();var n=e.getModel(),r=[];r.push({title:TranslationSystem.get("Rename"),cssClass:"rename",args:e.$view,callback:function(e){var t=$('<input type="text"/>').addClass("rename").val(e.text()).data("li",e).blur(function(n){e.find(".title").show(),t.remove()}).keyup(function(e){switch(e.keyCode){case 13:n.rename(t.val()),playlistManager.save(),$(this).blur();break;case 27:$(this).blur()}e.stopPropagation()});e.find(".title").hide(),e.append(t),t.focus().select()}}),UserManager.isLoggedIn()&&n.remoteId&&r.push({title:TranslationSystem.get("Share"),cssClass:"share",args:e.$view,callback:function(e){(new ShareTrackDialog(n)).show()}}),r.push({title:TranslationSystem.get("Import from Spotify"),cssClass:"import",args:e.$view,callback:function(e){e.arrowPopup("#spotify-importer","left")}}),r.push({title:TranslationSystem.get("Remove duplicate videos"),cssClass:"remove-duplicates",args:e.$view,callback:function(e){var t=e.index(),n=playlistManager.getPlaylist(t);confirm(TranslationSystem.get("This will delete duplicate videos from your playlist. Continue?"))&&Notifications.append(n.removeDuplicates()+TranslationSystem.get(" duplicates removed."))}}),UserManager.isLoggedIn()&&!n.remoteId&&r.push({title:TranslationSystem.get("Sync"),cssClass:"sync",args:e.$view,callback:function(e){e.data("model").sync(function(){playlistManager.save(),e.addClass("remote")})}}),UserManager.isLoggedIn()&&n.remoteId&&r.push({title:TranslationSystem.get("Unsync"),cssClass:"unsync",args:e.$view,callback:function(e){e.data("model").unsync(),playlistManager.save(),e.removeClass("remote")}}),ON_PRODUCTION||r.push({title:"View JSON",cssClass:"json",args:e.$view,callback:function(e){alert(JSON.stringify(n.toJSON())),console.log(n.toJSON())}}),r.push({title:TranslationSystem.get("Delete/Unsubscribe"),cssClass:"delete",args:e.$view,callback:function(e){var t=e.index(),n=playlistManager.getPlaylist(t);confirm("Are you sure you want to delete this playlist ("+n.title+")?")&&(playlistManager.deletePlaylist(t),playlistManager.save())}}),showContextMenu(r,t.pageX,t.pageY)}function showResultsItemContextMenu(e,t){var n=t||$(this),r=$(this).parent().find(".video.selected"),i=n.data("model"),s=[];r.length===0?s.push(i):$.each(r,function(e,t){var n=$(t).data("model");n&&s.push(n)}),$(n).hasClass("selected")||(n.parent().find(".selected").removeClass("selected"),n.addClass("selected"));var o=[{title:TranslationSystem.get("Play"),cssClass:"play",args:n,callback:function(e){e.data("model").play()}},{title:TranslationSystem.get("Queue"),cssClass:"queue",args:r,callback:function(e){$.each(e,function(e,t){var n=$(t).data("model");n&&Queue.addManual(n)})}},{title:TranslationSystem.get("Add to playlist"),cssClass:"add-to-playlist",args:r,callback:function(){(new AddToPlaylistDialog(s)).show()}},{title:TranslationSystem.get("Find similar tracks"),cssClass:"recommendations",args:r,callback:function(){Recommendations.findSimilarTracks(i)}},{title:TranslationSystem.get("Share"),cssClass:"share",args:n,callback:function(e){var t=$(e).data("model");(new ShareTrackDialog(t)).show()}},{title:i.getExternalLink().label,cssClass:"view",args:n,callback:function(e){var t=$(e).data("model");window.open(t.getExternalLink().url)}}];return ON_PRODUCTION||o.push({title:"View JSON",cssClass:"json",args:n,callback:function(e){alert(JSON.stringify(i.toJSON())),console.log(i.toJSON())}}),n.data("additionalMenuButtons")&&(o=$.merge(o,n.data("additionalMenuButtons"))),showContextMenu(o,e.pageX||n.offset().left+n.width(),e.pageY||n.offset().top),!1}function AbstractPlayer(){var e=this;e.initialized=!1,e.type=undefined,e.init=function(e){throw"Error in AbstractPlayer: This method must be overridden."},e.hide=function(){throw"Error in AbstractPlayer: This method must be overridden."},e.show=function(){throw"Error in AbstractPlayer: This method must be overridden."},e.play=function(e){throw"Error in AbstractPlayer: This method must be overridden."},e.stop=function(){throw"Error in AbstractPlayer: This method must be overridden."},e.pause=function(){throw"Error in AbstractPlayer: This method must be overridden."},e.fullScreenOn=function(){throw"Error in AbstractPlayer: This method must be overridden."},e.fullScreenOff=function(){throw"Error in AbstractPlayer: This method must be overridden."},e.setVolume=function(e){throw"Error in AbstractPlayer: This method must be overridden."},e.getVolume=function(){throw"Error in AbstractPlayer: This method must be overridden."},e.seekTo=function(e){throw"Error in AbstractPlayer: This method must be overridden."},e.getCurrentPlaybackTime=function(){throw"Error in AbstractPlayer: This method must be overridden."},e.getTotalPlaybackTime=function(){throw"Error in AbstractPlayer: This method must be overridden."}}function YouTubePlayer(){this.prototype=new AbstractPlayer;var e=this;e.initialized=!1,e.type="youtube",e.player=null,e.view=null,e.loadedNewVideo=!1,e.currentVideo=null,e.inFullScreen=!1,e.defaultWidth=$("#left .players").width(),e.defaultHeight=$("#left .players").height(),e.qualitySet=!1,e.init=function(t){var n="cpvty-isRCk",r=document.location.origin||document.location.protocol+"//"+document.location.host;if(t===null||t===undefined)t=function(){console.log("YouTube player loaded")};e.player=new YT.Player("youtube",{height:e.defaultHeight,width:e.defaultWidth,videoId:n,enablejsapi:1,modestbranding:1,origin:r,playerVars:{autoplay:0,controls:0,wmode:"opaque"},events:{onReady:function(n){e.initialized=!0,e.view=$("#youtube"),t&&t()},onStateChange:e.onPlayerStateChange,onError:e.onError}})},e.hide=function(){$("#youtube").css("left","-100000px")},e.show=function(){$("#youtube").css("left","0px")},e.onPlayerStateChange=function(t){if(t===null||t===undefined||t.data===null||t.data===undefined)return;switch(t.data){case YT.PlayerState.BUFFERING:e.qualitySet||(t.target.setPlaybackQuality((new Settings).quality),e.qualitySet=!0);break;case 0:e.currentVideo=null,EventSystem.callEventListeners("video_played_to_end",e);break;case 1:e.loadedNewVideo?(e.loadedNewVideo=!1,EventSystem.callEventListeners("video_started_playing_successfully",e.currentVideo)):EventSystem.callEventListeners("backend_played_video",e.currentVideo);break;case 2:EventSystem.callEventListeners("backend_paused_video",e.currentVideo);break;case 3:var n=e.player.getCurrentTime(),r=e.player.getDuration();n>r-2&&r>0&&EventSystem.callEventListeners("video_played_to_end",e);break;default:}},e.onError=function(t){console.log("YouTube player reported an error",t),e.currentVideo&&EventSystem.callEventListeners("video_failed_to_play",e.currentVideo)},e.play=function(t){var n=(new Settings).quality||"hd720";t?(e.qualitySet=!1,e.loadedNewVideo=!0,e.currentVideo=t,e.player.loadVideoById(t.videoId,0,n)):e.player.playVideo()},e.stop=function(){e.player&&(e.player.stopVideo(),e.currentVideo=null)},e.pause=function(){e.player.pauseVideo()},e.fullScreenOn=function(){var t=$(window).width(),n=$(window).height()-$("#bottom").outerHeight();if(e.view===null||e.view.left<0)return;$("#left .players").css("top",0),e.view.width(t),e.view.height(n),e.inFullScreen=!0},e.fullScreenOff=function(){if(e.view===null||e.view.left<0)return;$("#left .players").removeAttr("style"),e.view.width(e.defaultWidth),e.view.height(e.defaultHeight),e.inFullScreen=!1},e.setVolume=function(t){e.player&&e.player.setVolume&&e.player.setVolume(t)},e.getVolume=function(){return e.player.getVolume()},e.seekTo=function(t){e.currentVideo&&e.player.seekTo(t,!0)},e.getCurrentPlaybackTime=function(){return e.currentVideo?e.player.getCurrentTime():0},e.getTotalPlaybackTime=function(){return e.currentVideo?e.player.getDuration():0}}function SoundCloudPlayer(){this.prototype=new AbstractPlayer;var e=this;e.initialized=!1,e.type="soundcloud",e.video=null,e.view=null,e.volume=100,e.playedSuccessfully=!1,e.defaultWidth=$("#left .players").width(),e.defaultHeight=$("#left .players").height(),e.init=function(t){soundManager.onready(function(){e.view=$("#soundcloud"),EventSystem.addEventListener("video_info_fetched",function(t){if(e.video!==null){var n=null;t.thumbnail?n=t.thumbnail.replace("default.","t500x500.").replace("large.","t500x500."):t.author&&t.author.avatar_url&&(n=t.author.avatar_url,n.indexOf("default_avatar_large")<0&&(n=n.replace("large.","t500x500."))),n?e.view.css("backgroundImage","url("+n+")"):e.view.css("backgroundImage","none")}}),e.initialized=!0,t&&t(e)})},e.hide=function(){$("#soundcloud").hide()},e.show=function(){$("#soundcloud").show()},e.play=function(t){t?(e.video=t,soundManager.stopAll(),e.playedSuccessfully=!1,soundManager.createSound({id:t.videoId,url:"https://api.soundcloud.com/tracks/"+t.videoId+"/stream?consumer_key="+SOUNDCLOUD_API_KEY,volume:e.volume,onplay:function(){e.playedSuccessfully||(EventSystem.callEventListeners("video_started_playing_successfully",e.video),e.playedSuccessfully=!0)},onresume:function(){EventSystem.callEventListeners("backend_played_video",e.video)},onpause:function(){EventSystem.callEventListeners("backend_paused_video",e.video)},onfinish:function(){soundManager.destroySound("soundcloud"),EventSystem.callEventListeners("video_played_to_end",e)},onload:function(t){t?EventSystem.callEventListeners("video_duration_updated",e.getTotalPlaybackTime()):EventSystem.callEventListeners("video_failed_to_play",e.video)},whileloading:function(){EventSystem.callEventListeners("video_duration_updated",e.getTotalPlaybackTime())}}),soundManager.play(e.video.videoId)):soundManager.play(e.video.videoId)},e.stop=function(){e.video=null,soundManager.stopAll()},e.pause=function(){soundManager.pause(e.video.videoId)},e.fullScreenOn=function(){var t=$(window).width(),n=$(window).height()-$("#bottom").outerHeight();if(e.view===null)return;$("#left .players").css("top",0),e.view.width(t),e.view.height(n)},e.fullScreenOff=function(){if(e.view===null)return;$("#left .players").removeAttr("style"),e.view.width(e.defaultWidth),e.view.height(e.defaultHeight),e.inFullScreen=!1},e.setVolume=function(t){e.volume=t,e.video&&soundManager.setVolume(e.video.videoId,t)},e.getVolume=function(){return e.volume},e.seekTo=function(t){soundManager.setPosition(e.video.videoId,t*1e3)},e.getCurrentPlaybackTime=function(){if(!e.video)return 0;var t=soundManager.getSoundById(e.video.videoId);return t?t.position/1e3:0},e.getTotalPlaybackTime=function(){if(e.video&&e.video.duration)return e.video.duration/1e3;if(e.video){var t=soundManager.getSoundById(e.video.videoId);if(t)return t.durationEstimate/1e3}return 0}}function OfficialfmPlayer(){this.prototype=new AbstractPlayer;var e=this;e.initialized=!1,e.type="officialfm",e.video=null,e.view=null,e.volume=100,e.mp3_url="http://cdn.official.fm/",e.playedSuccessfully=!1,e.defaultWidth=$("#left .players").width(),e.defaultHeight=$("#left .players").height(),e.init=function(t){soundManager.onready(function(){e.view=$("#officialfm"),EventSystem.addEventListener("video_info_fetched",function(t){if(e.video!==null){var n=null;t.thumbnail?n=t.thumbnail.replace("_small.","_large."):t.author&&t.author.avatar_url&&(n=t.author.avatar_url.replace("_small.","_large.")),n?e.view.css("backgroundImage","url("+n+")"):e.view.css("backgroundImage","none")}}),e.initialized=!0,t&&t(e)})},e.hide=function(){$("#officialfm").hide()},e.show=function(){$("#officialfm").show()},e.play=function(t){t?(e.video=t,soundManager.stopAll(),e.playedSuccessfully=!1,soundManager.createSound({id:t.videoId,url:"http://cdn.official.fm/mp3s/"+Math.floor(t.videoId/1e3)+"/"+t.videoId+".mp3",volume:e.volume,onplay:function(){e.playedSuccessfully||(EventSystem.callEventListeners("video_started_playing_successfully",e.video),e.playedSuccessfully=!0)},onresume:function(){EventSystem.callEventListeners("backend_played_video",e.video)},onpause:function(){EventSystem.callEventListeners("backend_paused_video",e.video)},onfinish:function(){soundManager.destroySound("soundcloud"),EventSystem.callEventListeners("video_played_to_end",e)},onload:function(t){t?EventSystem.callEventListeners("video_duration_updated",e.getTotalPlaybackTime()):EventSystem.callEventListeners("video_failed_to_play",e.video)},whileloading:function(){EventSystem.callEventListeners("video_duration_updated",e.getTotalPlaybackTime())}}),soundManager.play(e.video.videoId)):soundManager.play(e.video.videoId)},e.stop=function(){e.video=null,soundManager.stopAll()},e.pause=function(){soundManager.pause(e.video.videoId)},e.fullScreenOn=function(){var t=$(window).width(),n=$(window).height()-$("#bottom").outerHeight();if(e.view===null)return;$("#left .players").css("top",0),e.view.width(t),e.view.height(n)},e.fullScreenOff=function(){if(e.view===null)return;$("#left .players").removeAttr("style"),e.view.width(e.defaultWidth),e.view.height(e.defaultHeight),e.inFullScreen=!1},e.setVolume=function(t){e.volume=t,e.video&&soundManager.setVolume(e.video.videoId,t)},e.getVolume=function(){return e.volume},e.seekTo=function(t){soundManager.setPosition(e.video.videoId,t*1e3)},e.getCurrentPlaybackTime=function(){if(!e.video)return 0;var t=soundManager.getSoundById(e.video.videoId);return t?t.position/1e3:0},e.getTotalPlaybackTime=function(){if(e.video&&e.video.duration)return e.video.duration/1e3;if(e.video){var t=soundManager.getSoundById(e.video.videoId);if(t)return t.durationEstimate/1e3}return 0}}function PlayerManager(){var e=this;e.initialized=!1,e.players=[],e.currentVideo=null,e.currentVideoLength=0,e.volume=100,e.currentPlayer=null,e.inFullScreen=!1,e.isPlaying=!1,e.init=function(){if(!youTubeApiReady){setTimeout(function(){e.init()},1e3);return}e.players.push(new YouTubePlayer),e.players.push(new SoundCloudPlayer),e.players.push(new OfficialfmPlayer),EventSystem.addEventListener("video_failed_to_play",e.findAndPlayAlternative),EventSystem.addEventListener("video_played_to_end",function(){e.isPlaying=!1,$("body").removeClass("playing"),Timeline.stop(),e.next()}),EventSystem.addEventListener("video_started_playing_successfully",e.internalPlay),EventSystem.addEventListener("backend_played_video",e.internalPlay),EventSystem.addEventListener("backend_paused_video",e.internalPause),e.initialized=!0,EventSystem.callEventListeners("player_manager_initialized",e),EventSystem.addEventListener("video_duration_updated",function(t){if(e.currentVideo.duration===null||e.currentVideo.duration===0)e.currentVideoLength=t}),EventSystem.addEventListener("uploader_info_fetched",function(t){e.currentVideo.artist=t.name}),EventSystem.addEventListener("window_resized",function(){e.inFullScreen&&e.currentPlayer&&e.currentPlayer.fullScreenOn()})},e.internalPlay=function(){Timeline.start(),e.isPlaying=!0,$("body").addClass("playing"),$("#bottom .info, #bottom .share-wrapper").show(),e.currentPlayer&&(e.currentVideoLength=e.currentPlayer.getTotalPlaybackTime()),e.currentVideo.scrollTo()},e.play=function(t){var n=0;if(t===null||t===undefined){if(!e.currentPlayer){console.log("Player.play() was called but Player.currentPlayer is null");return}e.internalPlay(),e.currentPlayer.play()}else{var r=function(){e.play(t)};if(t.type===null||t.type.length===0||t.type==="yt")t.type="youtube";e.currentPlayer&&e.currentPlayer.stop(),e.currentPlayer=null,BottomPanel.setTitleText("Loading...");if(t.type==="unresolved")e.findAndPlayAlternative(t);else for(n=0;n<e.players.length;n+=1)if(e.players[n].type===t.type){if(e.players[n].initialized===!1){e.players[n].show(),e.players[n].init(r);return}e.currentPlayer=e.players[n],e.configurePlayer(e.currentPlayer),e.currentPlayer.show()}else e.players[n].hide();if(e.currentPlayer===null){console.log("Player.play(): Could not find matching player to video type: "+t.type),BottomPanel.setTitleText("Failed to load track");return}e.currentVideo=t,e.currentPlayer.play(t)}},e.configurePlayer=function(t){if(!t.initialized){console.log("Player.configurePlayer(backendPlayer): backendPlayer is not initialized");return}t.setVolume(e.volume),e.inFullScreen?t.fullScreenOn():t.fullScreenOff()},e.internalPause=function(){if(e.currentPlayer===null||e.currentVideo===null){console.log("Player.pause(): currentPlayer or currentVideo is null");return}e.isPlaying=!1,Timeline.stop(),$("body").removeClass("playing"),$("body").addClass("paused")},e.pause=function(){if(e.currentPlayer===null||e.currentVideo===null){console.log("Player.pause(): currentPlayer or currentVideo is null");return}e.internalPause(),e.currentPlayer.pause()},e.playPause=function(){if(e.currentPlayer===null||e.currentVideo===null){console.log("Player.playPause(): currentPlayer or currentVideo is null");return}e.isPlaying?e.pause():e.play()},e.prev=function(){if(e.currentPlayer===null||e.currentVideo===null){console.log("Player.prev(): currentPlayer or currentVideo is null");return}e.getCurrentPlaybackTime()>3?e.seekTo(0):Queue.playPrev()},e.next=function(){var t;if(e.currentPlayer===null||e.currentVideo===null){console.log("Player.next(): currentPlayer or currentVideo is null");return}if(Queue.playNext())return;t=$("#right .playing").next(),t.hasClass("alternative")?t=t.parent().parent().next():t.hasClass("loadMore")&&(t.addClass("loading"),Search.searchVideos("",!0,!0)),t.length>0&&t.data("model").play()},e.toggleFullScreen=function(t){e.inFullScreen?e.fullScreenOff(t):e.fullScreenOn(t)},e.fullScreenOn=function(t){e.inFullScreen=!0,$("body").addClass("fullscreen");for(i=0;i<e.players.length;i+=1)e.players[i].initialized&&e.players[i].fullScreenOn()},e.fullScreenOff=function(){e.inFullScreen=!1,$("body").removeClass("fullscreen");for(i=0;i<e.players.length;i+=1)e.players[i].initialized&&e.players[i].fullScreenOff()},e.setVolume=function(t){var n;if(t<0||t>100){console.log("Player.setVolume("+t+"): argument must be >= 0 && <= 100");return}e.volume=t;for(n=0;n<e.players.length;n+=1)e.players[n].initialized&&e.players[n].setVolume(t)},e.getVolume=function(){return e.volume},e.setRelativeVolume=function(t){t+=e.getVolume(),t<=0?(e.setVolume(0),Volume.updateUI(0)):t>=100?(e.setVolume(100),Volume.updateUI(100)):(e.setVolume(t),Volume.updateUI(t))},e.seekTo=function(t){if(e.currentPlayer===null||e.currentVideo===null){console.log("Player.seekTo(): currentPlayer or currentVideo is null");return}if(!(t>=0&&t<=e.getTotalPlaybackTime())){console.log("Player.seekTo("+t+"): argument must be >= 0 and <= than "+e.getTotalPlaybackTime());return}e.currentPlayer.seekTo(t)},e.seek=function(t){if(e.currentPlayer===null||e.currentVideo===null){console.log("Player.seekTo(): currentPlayer or currentVideo is null");return}t+=e.getCurrentPlaybackTime(),t<=0?e.seekTo(0):t>=e.getTotalPlaybackTime()?e.seekTo(e.getTotalPlaybackTime()):e.seekTo(t)},e.getCurrentPlaybackTime=function(){if(e.currentPlayer===null)return 0;var t=e.currentPlayer.getCurrentPlaybackTime(),n=e.getTotalPlaybackTime();return t>n&&(t=n,e.currentVideoLength=null),t},e.getTotalPlaybackTime=function(){return e.currentVideoLength?e.currentVideoLength:e.currentPlayer?(e.currentVideoLength=e.currentPlayer.getTotalPlaybackTime(),e.currentVideoLength):0},e.findAndPlayAlternative=function(t){t.listView&&t.listView.addClass("alternative"),Search.findAlternative(t,function(n){var r;n?(e.play(n),t.listView&&(n.listView=t.listView,r=t.listView.parents(".tracklist"),r.length&&n.createAlternativeContextMenuButton(t,r.data("model")),t.listView.data("model",n))):e.next()})},e.getCurrentVideo=function(){return e.currentVideo}}function Video(e){var t=this;this.videoId=e.videoId,this.mbid=e.mbid||null,this.flattrThingId=e.flattrThingId||null,this.flattrs=e.flattrs||null,this.title=$.trim(e.title)||"",this.artist=e.artist||null,this.duration=e.duration||null,this.buyLinks=e.buyLinks||null,this.type=e.type||"youtube",this.onPlayCallback=e.onPlayCallback,this.listView=null,this.uploaderUsername=e.uploaderUsername||null,this.artworkURL=e.artworkURL||null,this.clone=function(){return new Video({videoId:this.videoId,mbid:this.mbid,title:this.title,type:this.type,duration:this.duration,onPlayCallback:this.onPlayCallback,uploaderUsername:this.uploaderUsername,artworkURL:this.artworkURL})},this.getUrl=function(){return location.protocol+"//"+location.host+"/tracks/"+this.type+"/"+this.videoId},this.getExternalLink=function(){var e={label:"",url:""};switch(this.type){case"youtube":e.label=TranslationSystem.get("View on YouTube"),e.url="http://www.youtube.com/watch?v="+this.videoId;break;case"soundcloud":e.label=TranslationSystem.get("View on SoundCloud"),e.url="/soundcloud_id_to_permalink?id="+this.videoId;break;case"officialfm":e.label=TranslationSystem.get("View on Official.fm"),e.url="http://www.official.fm/tracks/"+this.videoId}return e},this.getTwitterShareUrl=function(){var e=this.getUrl(),t="Check out this video! -- "+this.title;return encodeURI("http://twitter.com/share?related=youtify&via=youtify&url="+e+"&counturl="+e+"&text="+t)},this.getFacebookShareUrl=function(){var e=this.getUrl();return"http://facebook.com/sharer.php?u="+e},this.scrollTo=function(){var e=this.listView.parents("#right > div"),t=0,n=0;this.listView&&this.listView.is(":visible")&&(n=e.scrollTop(),t=this.listView.position().top+n-84,(t<n||t+this.listView.height()>n+e.height())&&e.animate({scrollTop:t},400))},this.createAlternativeContextMenuButton=function(e,n){var r=e.listView.data("additionalMenuButtons")||[],i;for(i=r.length-1;i>=0;i-=1)r[i].cssClass==="replace"&&r.splice(i,1);r.unshift({title:TranslationSystem.get("Replace with alternative"),cssClass:"replace",args:null,callback:function(){var r=0;for(r;r<n.videos.length;r+=1)n.videos[r]===e&&(n.videos.splice(r,1,t),n.synced=!1,n.sync(),t.createListView(),t.listView.insertAfter(e.listView),e.listView.remove())}})},this.createListView=function(){var e,n=this.getExternalLink(),r=document.createDocumentFragment(),i=document.createElement("td"),s=document.createElement("td"),o=document.createElement("td"),u=document.createElement("td"),a=document.createElement("td"),f=document.createElement("td"),l=document.createElement("td");i.setAttribute("class","space"),s.setAttribute("class","play"),s.onclick=function(e){t.play(e)},r.appendChild(s),r.appendChild(i.cloneNode(!1)),o.innerHTML=this.title,o.setAttribute("class","title"),r.appendChild(o),r.appendChild(i.cloneNode(!1)),u.innerHTML=this.uploaderUsername||"",u.setAttribute("class","uploader link"),r.appendChild(u),r.appendChild(i.cloneNode(!1)),a.setAttribute("class","like"),a.innerHTML="&hearts;",r.appendChild(a),r.appendChild(i.cloneNode(!1)),f.setAttribute("class","menu"),f.innerHTML="",r.appendChild(f),r.appendChild(i.cloneNode(!1)),l.setAttribute("class","type"),l.innerHTML='<a href="'+n.url+'" title="'+n.label+'" target="_blank">'+"&nbsp;"+"</a>",r.appendChild(l),this.listView=document.createElement("tr"),this.listView.setAttribute("class","draggable video "+this.type),this.listView.appendChild(r),this.listView=$(this.listView).bind("contextmenu",showResultsItemContextMenu).mousedown(function(e){t.listViewSelect(e)}).dblclick(function(e){t.play(e)}).data("model",this),this.listView.find(".menu").click(function(e){showResultsItemContextMenu(e,$(e.target).parent())}),this.uploaderUsername&&this.listView.find(".uploader").click(this.goToUploader),e=this.listView.data("additionalMenuButtons")||[];if(t.buyLinks&&t.buyLinks.length){var c;for(c=0;c<t.buyLinks.length;c+=1)e.push({title:TranslationSystem.get("Buy track"),cssClass:"buy",args:t.buyLinks[c],callback:Utils.openLink})}return this.listView.data("additionalMenuButtons",e),this.listView},this.goToUploader=function(){switch(t.type){case"soundcloud":ExternalUserPage.loadSoundCloudUser(t.uploaderUsername);break;case"youtube":ExternalUserPage.loadYouTubeUser(t.uploaderUsername);break;default:throw"Unknown type for external users: "+t.type}},this.listViewSelect=function(e,t){$("#left, #top .search").removeClass("focused"),$("#right").addClass("focused"),t===undefined&&(t=this.listView);if(t.hasClass("selected"))return;if(e!==undefined&&(e.ctrlKey||e.metaKey))t.hasClass("selected")?t.removeClass("selected"):(t.addClass("selected"),selectedVideoElements.push(t));else if(e!==undefined&&e.shiftKey&&t.siblings(".selected").length>0){var n=[t],r=!1;while(!r&&$(n[0]).next().length>0)n.unshift(n[0].next()),$(n[0]).hasClass("selected")&&(r=!0);if(!r){n=[t];while(!r&&$(n[0]).prev().length>0)n.unshift(n[0].prev()),$(n[0]).hasClass("selected")&&(r=!0)}$(n).each(function(e,t){$(t).addClass("selected")}),selectedVideoElements=selectedVideoElements.concat(n)}else Utils.deSelectSelectedVideos(),selectedVideoElements.push(t),t.addClass("selected")},this.play=function(e){$("#right .video").removeClass("playing"),this.listView.addClass("playing"),e&&(e.stopPropagation(),Queue.addSiblingsToPlayorder(this.listView)),this.onPlayCallback&&this.onPlayCallback(),player.play(this)},this.toJSON=function(){return{videoId:this.videoId,mbid:this.mbid,title:this.title,duration:this.duration,type:this.type,buyLinks:this.buyLinks}}}function loadPlaylist(e){$.ajax({url:"/api/playlists/"+e,type:"GET",statusCode:{200:function(e){var t=new Playlist(e.title,e.videos,e.remoteId,e.owner,e.isPrivate,e.followers);PlaylistView.loadPlaylistView(t),playlistManager.selectPlaylistByRemoteId(e.remoteId)},403:function(e){alert("Looks like this playlist is private")},404:function(e){alert("No such playlist found")}}})}function playlistMenuItemSelected(e){var t=e.getModel();t.remoteId?history.pushState(null,null,t.getUrl()):history.pushState(null,null,"/"),PlaylistView.loadPlaylistView(t)}function Playlist(e,t,n,r,i,s){var o,u=this;u.title=e,u.videos=[],u.remoteId=n||null,u.owner=r,r&&(u.owner=new User(r)),u.isPrivate=i||!1,u.followers=s||[],u.synced=!0,u.syncing=!1,u.isSubscription=!1;for(o=0;o<u.followers.length;o+=1)if(Number(u.followers[o].id)===Number(UserManager.currentUser.id)){u.isSubscription=!0;break}u.menuItem=null,u.$tracklist=null,u.getTwitterShareUrl=function(){var e=u.getUrl(),t="Check out this playlist! -- "+u.title;return encodeURI("http://twitter.com/share?related=youtify&via=youtify&url="+e+"&counturl="+e+"&text="+t)},u.getFacebookShareUrl=function(){var e=u.getUrl();return"http://facebook.com/sharer.php?u="+e},u.getUrl=function(){return u.owner.getUrl()+"/playlists/"+u.remoteId},u.copy=function(){return new Playlist(u.title,u.videos)},u.getMenuItem=function(){if(u.menuItem===null){var e={title:u.title,$contentPane:$("#right > .playlists"),cssClasses:["playlistElem"],onSelected:playlistMenuItemSelected,onContextMenu:showPlaylistContextMenu,model:u};u.isSubscription?(e.cssClasses.push("subscription"),e.$img=$('<img class="owner" />').attr("src",u.owner.smallImageUrl)):e.cssClasses.push("droppable"),u.remoteId?e.cssClasses.push("remote"):e.cssClasses.push("local"),u.isPrivate&&e.cssClasses.push("private"),u.menuItem=new MenuItem(e)}return u.menuItem},u.getTrackList=function(){return u.$tracklist===null&&(u.$tracklist=$("<table/>").addClass("pane").addClass("tracklist").appendTo("#right > .playlists").data("model",u)),u.$tracklist},u.setAsPlaying=function(){u.getMenuItem().setAsPlaying()},u.rename=function(e){var t=$.trim(e);t.length>0&&t.length<50&&(u.title=e),u.synced=!1,u.getMenuItem().setTitle(e)},u.unsync=function(e){var t="/api/playlists/"+u.remoteId;u.isSubscription&&(t="/api/playlists/"+u.remoteId+"/followers"),LoadingBar.show(),$.ajax({type:"DELETE",url:t,complete:function(e,t){LoadingBar.hide()},statusCode:{200:function(t){e&&(u.isSubscription=!1,e())},404:function(e){alert(TranslationSystem.translations["No such playlist found"])},409:function(e){(new ReloadDialog).show()}}}),u.isSubscription||(u.remoteId=null,u.owner=null)},u.subscribe=function(e){var t={device:device};u.syncing=!0,LoadingBar.show(),$.ajax({type:"POST",url:"/api/playlists/"+u.remoteId+"/followers",data:t,complete:function(e,t){LoadingBar.hide()},statusCode:{200:function(t,n){u.syncing=!1,u.isSubscription=!0,u.followers.push(UserManager.currentUser),n==="success"?u.synced=!0:alert("Failed to create new playlist "+u.title),playlistManager.addPlaylist(u),e&&e()},404:function(e){alert(TranslationSystem.translations["No such playlist found"])},409:function(e){(new ReloadDialog).show()}}})},u.createNewPlaylistOnRemote=function(e){var t={json:JSON.stringify(u.toJSON()),device:device};u.syncing=!0,$.ajax({type:"POST",url:"/api/playlists",data:t,statusCode:{200:function(t,n){u.syncing=!1,n==="success"?(u.remoteId=t.remoteId,u.owner=new User(t.owner),u.synced=!0):alert("Failed to create new playlist "+u.title),e&&e()},409:function(e){(new ReloadDialog).show()}}})},u.updatePlaylistOnRemote=function(e){if(u.isSubscription)return;var t={json:JSON.stringify(u.toJSON()),device:device};u.syncing=!0,$.ajax({type:"POST",url:"/api/playlists/"+u.remoteId,data:t,statusCode:{200:function(t,n){u.syncing=!1,n==="success"?u.synced=!0:alert("Failed to create new playlist "+u.title),e&&e()},404:function(e){alert(TranslationSystem.translations["No such playlist found"])},409:function(e){(new ReloadDialog).show()}}})},u.sync=function(e){u.remoteId&&u.synced?e():u.remoteId?u.updatePlaylistOnRemote(e):u.createNewPlaylistOnRemote(e)},u.addVideo=function(e){if(u.isSubscription)return;if(u.syncing){alert("Please wait until the playlist is synced");return}var t=e.clone();t.onPlayCallback=u.setAsPlaying,u.videos.push(t);var n=t.createListView(),r=n.data("additionalMenuButtons")||[];r.push({title:"Delete",cssClass:"delete",args:n,callback:PlaylistView.deleteVideoButtonClicked}),n.data("additionalMenuButtons",r),n.addClass("droppable"),n.addClass("draggable"),n.addClass("reorderable"),n.appendTo(u.getTrackList()),u.synced=!1},u.moveVideo=function(e,t){if(u.isSubscription)return;if(u.syncing){alert("Please wait until the playlist is synced");return}var n;t>e&&(t-=1),n=u.videos.splice(e,1)[0],u.videos.splice(t,0,n),u.synced=!1},u.deleteVideo=function(e){if(u.isSubscription)return;if(u.syncing){alert("Please wait until the playlist is synced");return}u.videos.splice(e,1),u.synced=!1},u.toJSON=function(){return{title:u.title,videos:u.videos,remoteId:u.remoteId,owner:u.owner,isPrivate:u.isPrivate}},u.removeDuplicates=function(){var e=0,t,n;for(t=u.videos.length-1;t>0;t-=1)for(n=t-1;n>=0;n-=1)if(u.videos[t].videoId===u.videos[n].videoId){u.deleteVideo(n),e+=1;break}return playlistManager.save(),PlaylistView.loadPlaylistView(u),e},u.goTo=function(){history.pushState(null,null,u.owner.getUrl()+"/playlists/"+u.remoteId),Menu.deSelect(),loadPlaylist(u.remoteId)},u.getSmallView=function(){var e=$('<span class="playlist link"></span>');return e.text(u.title),e.click(u.goTo),e},u.getSearchView=function(){var e=$('<div class="playlist"></div>');return e.append(u.getSmallView()),e.append($("<span> by </span>")),e.append(u.owner.getSmallView()),e},typeof t=="string"&&(t=JSON.parse(t));for(o=0;o<t.length;o+=1)if(t[o]){var a=new Video({videoId:t[o].videoId,mbid:t[o].mbid,title:t[o].title,type:t[o].type,duration:t[o].duration,onPlayCallback:u.setAsPlaying});u.videos.push(a)}}function PlaylistsManager(){this.playlists=[],this.load=function(){var e=this,t,n,r;try{t=JSON.parse(localStorage.playlists||"[]");for(r=0;r<t.length;r+=1)n=t[r],n&&!n.remoteId&&this.playlists.push(new Playlist(n.title,n.videos,n.remoteId,n.owner,n.isPrivate))}catch(i){alert("Error parsing playlists from localStorage: "+i)}UserManager.isLoggedIn()?$.getJSON("/me/playlists",function(t){e.mergePlaylists(t),e.updateMenu(),EventSystem.callEventListeners("playlists_loaded",e.playlists)}):(e.updateMenu(),EventSystem.callEventListeners("playlists_loaded",e.playlists))},this.updateMenu=function(){var e=Menu.getGroup("playlists");e.clear(),$.each(this.playlists,function(e,t){Menu.getGroup("playlists").addMenuItem(t.getMenuItem())})},this.removeRemotePlaylistsFromLocalStorage=function(){var e=[];$.each(this.playlists,function(t,n){n.remoteId||e.push(n)}),this.playlists=e,this.saveToLocalStorage()},this.getCurrentlySelectedPlaylist=function(){return $("#left .playlists .selected").data("model")},this.getPlaylistsMap=function(){var e={};return $.each(this.playlists,function(t,n){n.remoteId!==null&&(e[n.remoteId]=n)}),e},this.mergePlaylists=function(e){var t=this,n=this.getPlaylistsMap();$.each(e,function(e,r){var i=r.title,s=r.videos,o=r.remoteId,u=r.owner,a=r.isPrivate||!1,f=r.followers||[];n.hasOwnProperty(o)||t.addPlaylist(new Playlist(i,s,o,u,a,f))}),t.saveToLocalStorage()},this.save=function(){this.saveToLocalStorage(),UserManager.isLoggedIn()&&this.playlists.length&&this.syncPlaylists(0)},this.saveToLocalStorage=function(){var e=(new Date).getTime(),t,n;while(this.locked){t=(new Date).getTime(),n=t-e;if(n>1e4){alert("Error: save function timed out.");return}}this.locked=!0;try{localStorage.playlists=JSON.stringify(this.playlists)}catch(r){alert("Error saving playlists: "+r)}this.locked=!1},this.syncPlaylists=function(e){if(e>=this.playlists.length){this.saveToLocalStorage();return}var t=this.playlists[e],n=this;t.remoteId?t.sync(function(){n.syncPlaylists(e+1)}):n.syncPlaylists(e+1)},this.addPlaylist=function(e){if(typeof e!="object")throw"playlist param must be object";this.playlists.push(e),Menu.getGroup("playlists").addMenuItem(e.getMenuItem())},this.getPlaylist=function(e){if(e>this.playlists.length-1||e<0)throw"No playlist at index "+e;return this.playlists[e]},this.setPlaylist=function(e,t){if(typeof t!="object")throw"playlist param must be object";if(e>this.playlists.length-1||e<0)throw"No playlist at index "+e;this.playlists[e]=t},this.movePlaylist=function(e,t){t>e&&(t-=1);var n=this.playlists.splice(e,1)[0];this.playlists.splice(t,0,n)},this.deletePlaylist=function(e){var t,n;if(e instanceof Playlist){n=e,t=this.getIndexOfPlaylist(e);if(t===undefined){console.log("Could not find index for playlist "+e.title);return}}else t=e,n=this.playlists[t];UserManager.isLoggedIn()&&n.remoteId&&n.unsync(),this.playlists.splice(t,1),Menu.deSelect(),Menu.getGroup("playlists").removeMenuItem(n.getMenuItem())},this.getIndexOfPlaylist=function(e){var t,n;for(t=0;t<this.playlists.length;t+=1){n=this.playlists[t];if(n.remoteId===e.remoteId)return t}},this.selectPlaylistByRemoteId=function(e){var t=this.getPlaylistsMap();t.hasOwnProperty(e)&&t[e].getMenuItem().select()},this.getDropdownOfAllPlaylists=function(){var e=$("<select></select>"),t,n;for(n=0;n<this.playlists.length;n+=1)t=this.playlists[n],(t.remoteId===null||t.owner.id===UserManager.currentUser.id)&&$("<option></option>").val(n).text(t.title).appendTo(e);return e},this.load()}function SpotifyImporter(){function e(){}this.wait=200,this.longWait=0,this.spotifyIds=[],this.added=0,this.max=0,this.callbackUpdate=null,this.callbackDone=null,this._cancel=!1,this.cancel=function(){this._cancel=!0},this.start=function(t,n,r,i){this.callbackUpdate=r||e,this.callbackDone=i||e,this.added=0,this.max=0,this.spotifyIds=[],this._cancel=!1;var s=this,o=$.trim(t).split("\n");$.each(o,function(e,t){t=$.trim(t).replace("http://open.spotify.com/track/","").replace("spotify:track:","");if(t.indexOf("open.spotify.com/local/")>0||t.indexOf("spotify:local")>0){t=$.trim(t).replace("http://open.spotify.com/local/","").replace("spotify:local:","");var r=t.split("/");r.length<2&&(r=t.split(":"));var i=r[0],o=r[2];s.max+=1,s.findAndAddToPlaylist(i+" - "+o,n)}else t.length>0&&(s.spotifyIds.push(t),s.max+=1)}),this.addFromSpotifyToPlaylist(n)},this.addFromSpotifyToPlaylist=function(e){if(this._cancel)return;var t=this,n;if(!(this.spotifyIds.length>0))return;n=this.spotifyIds[0];var r="http://ws.spotify.com/lookup/1/.json?uri=spotify:track:"+n;$.getJSON(r,{},function(n){if(n!==undefined){var r=n.track.name;n.track.artists.length>0&&(r=n.track.artists[0].name+" - "+n.track.name)}t.findAndAddToPlaylist(r,e),t.spotifyIds.shift(),t.longWait=0,setTimeout(function(){t.addFromSpotifyToPlaylist(e)},t.wait)}).error(function(n){n.status===404?(t.spotifyIds.shift(),setTimeout(function(){t.addFromSpotifyToPlaylist(e)},t.wait)):n.status===0?(t.longWait+=1e4,t.wait*=2,setTimeout(function(){t.addFromSpotifyToPlaylist(e)},t.longWait)):(console.log(n),alert(n.statusText))})},this.findAndAddToPlaylist=function(e,t){var n=this,r="http://gdata.youtube.com/feeds/api/videos?callback=?",i={alt:"json-in-script","max-results":1,"start-index":1,format:5,q:e};$.getJSON(r,i,function(e){if(e.feed.entry===undefined)return;$.each(e.feed.entry,function(e,r){var i=r.id.$t,s=i.match("videos/(.*)$")[1],o=r.title.$t;t.addVideo(new Video({videoId:s,title:o,type:"youtube",onPlayCallback:t.setAsPlaying})),n.added+=1}),n.updatedPlaylist()})},this.updatedPlaylist=function(){this.spotifyIds.length>0?this.callbackUpdate():(playlistManager.save(),this.callbackDone())}}function MenuItemGroup(e){var t=this;t.$view=e,t.$ul=e.find("ul"),t.menuItems=[],t.removeMenuItem=function(e){e.$view.remove()},t.addMenuItem=function(e){t.menuItems.push(e),t.$ul.append(e.$view),e.onAfterAdd()},t.clear=function(){t.menuItems=[],t.$ul.html("")}}function MenuItem(e){var t=this;t.$view=$("<li/>"),t.$contentPane=e.$contentPane,t.model=null,t.onSelected=e.onSelected,t.onContextMenu=e.onContextMenu,$('<span class="title"></span>').text(e.title).appendTo(t.$view),e.model&&(t.model=e.model,t.$view.data("model",e.model)),e.$img&&t.$view.append(e.$img),$.each(e.cssClasses,function(e,n){t.$view.addClass(n)}),e.translatable&&t.$view.addClass("translatable"),t.onAfterAdd=function(){t.$view.mousedown(t.select),e.onContextMenu&&t.$view.bind("contextmenu",function(n){return t.select(),e.onContextMenu(t,n)})},t.isSelected=function(){return t===Menu.selectedMenuItem},t.select=function(){$("#right, #top .search").removeClass("focused"),$("#left").addClass("focused"),Menu.selectedMenuItem&&Menu.selectedMenuItem.deSelect(),$("#right > div").hide(),t.$view.addClass("selected"),t.$contentPane&&t.$contentPane.show(),t.onSelected&&t.onSelected(t),Menu.selectedMenuItem=t},t.getModel=function(){return t.model},t.deSelect=function(){t.$view.removeClass("selected"),t.$contentPane&&t.$contentPane.hide(),Menu.selectedMenuItem===t&&(Menu.selectedMenuItem=null)},t.setAsNotPlaying=function(){t.$view.removeClass("playing"),Menu.playingMenuItem===t&&(Menu.playingMenuItem=null)},t.setAsPlaying=function(){Menu.playingMenuItem&&Menu.playingMenuItem.setAsNotPlaying(),t.$view.addClass("playing"),Menu.playingMenuItem=t},t.setTitle=function(e){t.$view.find(".title").text(e)}}function Tabs(e,t){var n=this;n.callbacks=t||{},n.$selectedTab=null,n.$selectedPane=null,n.$wrapper=e,n.$wrapper.find(".tabs li").click(function(){n.select($(this).attr("rel"))}),n.select=function(e){n.$selectedTab&&n.$selectedTab.removeClass("selected"),n.$selectedPane&&n.$selectedPane.hide().removeClass("selected"),n.$selectedTab=n.$wrapper.find(".tabs ."+e),n.$selectedPane=n.$wrapper.find(".pane."+e),n.$selectedTab.show().addClass("selected"),n.$selectedPane.show().addClass("selected"),n.callbacks.hasOwnProperty(e)&&n.callbacks[e]()}}function ArtistSuggestion(e){this.mbid=e.mbid,this.name=e.name,this.imageUrl=e.imageUrl,this.getSmallView=function(){var e=this,t=$('<div class="suggestion artist"></div>');return $("<img/>").attr("src",this.imageUrl).appendTo(t),$('<span class="link name"></span>').text(this.name).appendTo(t),t.click(function(){e.goTo()}),t},this.goTo=function(){$("#top .search input").val(this.name).keyup()}}function User(e){var t=this;t.id=e.id,t.nickname=e.nickname,t.displayName=e.displayName,t.flattrUserName=e.flattr_user_name,t.lastfmUserName=e.lastfm_user_name,t.email=e.email,t.largeImageUrl=e.largeImageUrl,t.smallImageUrl=e.smallImageUrl,t.firstName=e.firstName,t.lastName=e.lastName,t.fullName=$.trim(t.firstName+" "+t.lastName),t.nrOfFollowers=e.nr_of_followers,t.nrOfFollowings=e.nr_of_followings,t.nrOfPlaylists=e.nr_of_playlists,t.nrOfFlattrs=e.nr_of_flattrs,t.tagline=e.tagline,t.saveProfile=function(e){LoadingBar.show(),$.ajax({type:"POST",url:"/me/profile",data:e,statusCode:{200:function(t,n){LoadingBar.hide(),e.displayName=t,EventSystem.callEventListeners("user_profile_updated",e)},400:function(e,t){alert(e.responseText),LoadingBar.hide()},409:function(e){alert("Nickname is already taken"),LoadingBar.hide()}}})},t.getUrl=function(){var e=location.protocol+"//"+location.host+"/";return this.nickname?e+=this.nickname:e+="users/"+this.id,e},t.goTo=function(){UserManager.isLoggedIn()&&t.id===UserManager.currentUser.id?UserManager.loadCurrentUser():(UserManager.loadProfile(t.id),UserManager.show())},t.getSmallView=function(){var e=$('<span class="user small link"></span>');return $("<img />").attr("src",t.smallImageUrl).appendTo(e),$('<span class="name"></span>').text(t.displayName).appendTo(e),e.click(t.goTo),e}}function ExternalUserSubscription(e){var t=this;t.externalUserId=e.external_user_id,t.type=e.type,t.username=e.username,t.displayName=e.display_name,t.avatarUrl=e.avatar_url,t.menuItem=null,t.getMetaData=function(){return{username:t.username,avatar_url:t.avatarUrl}},t.goTo=function(){console.log(t,"goto"),ExternalUserPage.load(t.type,t.username)},t.getUrl=function(){return"/"+t.type+"/"+t.externalUserId},t.getApiUrl=function(){return"/api/external_users/"+t.type+"/"+t.externalUserId+"/subscribers"},t.equals=function(e){return t.externalUserId===e.externalUserId&&t.type===e.type},t.getMenuItem=function(){return t.menuItem===null&&(t.menuItem=new MenuItem({cssClasses:["external-user-subscription",t.type],title:t.username,$img:$("<img/>").attr("src",t.avatarUrl),onSelected:function(){ExternalUserPage.load(t.type,t.username)}})),t.menuItem}}function ModalBox(){var e=this;this.view=$('<div class="modalbox"><div class="wrapper"><div class="top"></div><p></p><div class="buttons"></div></div></div>')}function ReloadDialog(){ModalBox.call(this),this.setMessage("Looks like your account has been used somewhere else, please reload the page."),this.addButton("Reload",function(e){location.reload()},"exposed")}function EditProfileDialog(){ModalBox.call(this),this.view.addClass("edit-profile"),this.view.find(".wrapper p").append($("<span></span>").text(TranslationSystem.get("Nickname:"))),this.view.find(".wrapper p").append($('<input type="text" name="nickname" />').val(UserManager.currentUser.nickname)),this.view.find(".wrapper p").append($("<span></span>").text(TranslationSystem.get("First name:"))),this.view.find(".wrapper p").append($('<input type="text" name="first_name" />').val(UserManager.currentUser.firstName)),this.view.find(".wrapper p").append($("<span></span>").text(TranslationSystem.get("Last name:"))),this.view.find(".wrapper p").append($('<input type="text" name="last_name" />').val(UserManager.currentUser.lastName)),this.view.find(".wrapper p").append($("<span></span>").text(TranslationSystem.get("Tagline:"))),this.view.find(".wrapper p").append($('<textarea name="tagline"></textarea>').val(UserManager.currentUser.tagline)),this.setCanBeClosed(!0),this.addButton(TranslationSystem.get("Cancel"),function(e){e.remove()}),this.addButton(TranslationSystem.get("Save"),function(e){var t={};$.each(e.view.find("input, textarea"),function(e,n){t[n.name]=n.value}),UserManager.currentUser.saveProfile(t),e.remove()},"exposed")}function ShareTrackDialog(e){ModalBox.call(this),this.view.addClass("share"),this.view.find(".wrapper p").append($('<input type="text" />').val(e.getUrl()));var t=$('<div class="share-button twitter"></span>').text(TranslationSystem.get("Share on Twitter")).click(function(t){return t.preventDefault(),window.open(e.getTwitterShareUrl(),TranslationSystem.get("Share on Twitter"),"width=500, height=300"),!1}),n=$('<div class="share-button facebook"></span>').text(TranslationSystem.get("Share on Facebook")).click(function(t){return t.preventDefault(),window.open(e.getFacebookShareUrl(),TranslationSystem.get("Share on Facebook"),"width=500, height=300"),!1});this.view.find(".wrapper .buttons").append(t),this.view.find(".wrapper .buttons").append(n),this.setCanBeClosed(!0)}function AddToPlaylistDialog(e){ModalBox.call(this),this.view.addClass("add-to-playlist"),this.view.find(".wrapper p").append(playlistManager.getDropdownOfAllPlaylists()),this.addButton(TranslationSystem.get("Add to playlist"),function(t){var n=t.view.find("select").val(),r=playlistManager.getPlaylist(n);$.each(e,function(e,t){r.addVideo(t)}),playlistManager.save(),t.remove()},"exposed"),this.setCanBeClosed(!0)}function onYouTubePlayerAPIReady(){youTubeApiReady=!0}(function(e){e.fn.arrowPopup=function(t,n){n=n||"up";var r=e(t).removeAttr("style"),i=e('<span class="arrow"></span>').addClass(n),s=e(this).offset(),o=20,u=10,a=0,f=0,l=s.left+e(this).outerWidth()/2;switch(n){case"up":a=l-r.outerWidth()/2,f=s.top+e(this).outerHeight()+(u+5),i.css({top:f-u,left:l-o/2});break;case"down":a=l-r.outerWidth()/2,f=s.top-(r.outerHeight()+u+5),i.css({top:f+r.outerHeight()-1,left:l-o/2});break;case"left":f=s.top+e(this).outerHeight()/2-r.outerHeight()/2,a=230,i.css({top:f+r.outerHeight()/2-o/2+5,left:a-(u+5)})}var c=a+r.outerWidth(),h=e(window).width()-25;return f<0&&(r.css("height",r.height()+f-20),r.css("overflow-y","scroll"),f=20),c>h&&(a-=c-h),a<0&&(a=0),e('<div id="arrow-popup-blocker" class="blocker"></div>').click(function(t){e(this).remove(),i.remove(),r.hide(),t.stopPropagation()}).appendTo("body"),r.css({top:f,left:a}).show(),i.insertAfter(r),this}})(jQuery);var SettingsPopup={chromeWebStoreAppLink:"https://chrome.google.com/webstore/detail/ceimdjnelbadcaempefhdpdhdokpnbho",puffs:[],init:function(){var e=new Settings,t=0,n=JSON.parse(localStorage.viewedPuffs||"[]"),r;SettingsPopup.isBrowserChrome()&&!SettingsPopup.isChromeWebStoreAppInstalled()?(r=".chrome-webstore",n.indexOf(r)===-1&&(t+=1),$("#settings .puffs .chrome-webstore").attr("rel",r).click(function(e){e.preventDefault(),SettingsPopup.installChromeWebStoreApp()}),SettingsPopup.puffs.push(r)):$("#settings .puffs .chrome-webstore").hide(),SettingsPopup.puffs.length&&$("#settings .puffs").show(),t>0&&$("#top .menu .settings .counter").text(t).show(),UserManager.isLoggedIn()?(UserManager.currentUser.flattrUserName?($('<a class="title" target="_blank"></a>').attr("href","https://flattr.com/profile/"+UserManager.currentUser.flattrUserName).text(UserManager.currentUser.flattrUserName).appendTo("#settings .connections .flattr .account"),$('<a class="action disconnect translatable" href="/flattrdisconnect"></a>').text(TranslationSystem.get("Disconnect")).appendTo("#settings .connections .flattr .account")):($('<span class="title">Flattr</span>').appendTo("#settings .connections .flattr .account"),$('<a class="action connect translatable" href="/flattrconnect"></a>').text(TranslationSystem.get("Connect")).appendTo("#settings .connections .flattr .account"),$("#settings .connections .flattr .settings input[name=flattr_automatically]").attr("disabled","disabled")),UserManager.currentUser.lastfmUserName?($('<a class="title" target="_blank"></a>').attr("href","http://www.last.fm/user/"+UserManager.currentUser.lastfmUserName).text(UserManager.currentUser.lastfmUserName).appendTo("#settings .connections .lastfm .account"),$('<a class="action disconnect translatable" href="/lastfm/disconnect"></a>').text(TranslationSystem.get("Disconnect")).appendTo("#settings .connections .lastfm .account")):($('<span class="title">Last.fm</span>').appendTo("#settings .connections .lastfm .account"),$('<a class="action connect translatable" href="/lastfm/connect"></a>').text(TranslationSystem.get("Connect")).appendTo("#settings .connections .lastfm .account"),$("#settings .connections .lastfm .settings input[name=lastfm_scrobble_automatically]").attr("disabled","disabled"))):($("#settings .connections").hide(),$("#settings .notifications").hide(),$("#settings .notifications").hide()),function(){var e=new Settings;e.flattr_automatically&&$("#settings .connections .flattr .settings input[name=flattr_automatically]").attr("checked","checked"),e.lastfm_scrobble_automatically&&$("#settings .connections .lastfm .settings input[name=lastfm_scrobble_automatically]").attr("checked","checked")}(),$("#settings .connections .flattr .settings input[name=flattr_automatically]").change(function(){var e=new Settings;settingsFromServer.flattr_automatically=this.checked,e.flattr_automatically=this.checked,e.save()}),$("#settings .connections .lastfm .settings input[name=lastfm_scrobble_automatically]").change(function(){var e=new Settings;settingsFromServer.lastfm_scrobble_automatically=this.checked,e.lastfm_scrobble_automatically=this.checked,e.save()}),$("#qualityLowRadio").attr("checked",e.quality==="small").change(function(){var e=new Settings;e.quality="small",e.save()}),$("#qualityHighRadio").attr("checked",e.quality==="hd720").change(function(){var e=new Settings;e.quality="hd720",e.save()}),$.each(languagesFromServer,function(t,n){var r=$("<option></option>").attr("value",n.code).text(n.label);n.code===e.language&&r.attr("selected","selected"),r.appendTo("#settings .language select")}),$("#settings .language select").change(function(){var e=$(this).val(),t=new Settings;t.language=e,t.save(),TranslationSystem.changeLanguage(e)}),function(){var e=new Settings;e.send_new_follower_email&&$("#settings input[name=send_new_follower_email]").attr("checked","checked"),e.send_new_subscriber_email&&$("#settings input[name=send_new_subscriber_email]").attr("checked","checked")}(),$("#settings input[name=send_new_follower_email]").change(function(){var e=new Settings;settingsFromServer.send_new_follower_email=this.checked,e.send_new_follower_email=this.checked,e.save()}),$("#settings input[name=send_new_subscriber_email]").change(function(){var e=new Settings;settingsFromServer.send_new_subscriber_email=this.checked,e.send_new_subscriber_email=this.checked,e.save()})},getNumberOfUnseenPuffs:function(){var e=JSON.parse(localStorage.viewedPuffs||"[]"),t=0;return $.each($("#settings .puffs .puff"),function(n,r){e.indexOf(r.rel)===-1&&(t+=1)}),t},markAllPuffsAsSeen:function(){var e=[];$.each($("#settings .puffs .puff"),function(t,n){e.push(n.rel)}),localStorage.viewedPuffs=JSON.stringify(e),$("#top .menu .settings .counter").hide()},isBrowserChrome:function(){return navigator&&navigator.userAgent&&navigator.userAgent.indexOf("Chrome")!==-1},isChromeWebStoreAppInstalled:function(){return window.chrome&&window.chrome.app&&window.chrome.app.isInstalled},installChromeWebStoreApp:function(){var e=function(){Notifications.append("Failed to install App.")},t=function(){Notifications.append("Installation succeded!"),$("#settings .puffs .chrome-webstore").hide()};window.chrome&&window.chrome.webstore?window.chrome.webstore.install(SettingsPopup.chromeWebStoreAppLink,t,e):e()}},TranslationSystem={TRANSLATABLE_ATTRIBUTES:["title","alt","placeholder"],translations:undefined,init:function(){var e=new Settings;TranslationSystem.changeLanguage(e.language),$("#translations").click(function(){$(this).arrowPopup("#translationsPopup")})},get:function(e,t){var n=e,r;TranslationSystem.translations&&TranslationSystem.translations.hasOwnProperty(e)&&TranslationSystem.translations[e].length&&(n=TranslationSystem.translations[e]);for(r in t)t.hasOwnProperty(r)&&(n=n.replace(r,t[r]));return n},updateMarkup:function(e){TranslationSystem.translations=e,$(".translatable").each(function(e,t){t=$(t);var n=t.data("translationKeys")||{},r;n.hasOwnProperty("text")?r=n.text:(r=t.text(),n.text=r),TranslationSystem.translations.hasOwnProperty(r)&&t.text(TranslationSystem.get(r)),$.each(TranslationSystem.TRANSLATABLE_ATTRIBUTES,function(e,i){t.attr(i)!==undefined&&(n.hasOwnProperty(i)?r=n[i]:(r=t.attr(i),n[i]=r),TranslationSystem.translations.hasOwnProperty(r)&&t.attr(i,TranslationSystem.get(r)))}),t.data("translationKeys",n)})},changeLanguage:function(e){$("#settings .language option[value="+e+"]").attr("selected","selected"),autoDetectedLanguageByServer===e?(TranslationSystem.updateMarkup(autoDetectedTranslations),EventSystem.callEventListeners("language_changed",e)):$.getJSON("/api/translations/"+e,function(t,n){TranslationSystem.updateMarkup(t),EventSystem.callEventListeners("language_changed",e)});switch(e){case"sv_SE":jQuery.timeago.settings.strings={prefixAgo:"för",prefixFromNow:"om",suffixAgo:"sedan",suffixFromNow:"",seconds:"mindre än en minut",minute:"ungefär en minut",minutes:"%d minuter",hour:"ungefär en timme",hours:"ungefär %d timmar",day:"en dag",days:"%d dagar",month:"ungefär en månad",months:"%d månader",year:"ungefär ett år",years:"%d år"};break;case"fi_FI":jQuery.timeago.settings.strings={prefixAgo:null,prefixFromNow:null,suffixAgo:"sitten",suffixFromNow:"tulevaisuudessa",seconds:"alle minuutti",minute:"minuutti",minutes:"%d minuuttia",hour:"tunti",hours:"%d tuntia",day:"päivä",days:"%d päivää",month:"kuukausi",months:"%d kuukautta",year:"vuosi",years:"%d vuotta"};break;case"de_DE":jQuery.timeago.settings.strings={prefixAgo:"vor",prefixFromNow:"in",suffixAgo:"",suffixFromNow:"",seconds:"wenigen Sekunden",minute:"etwa einer Minute",minutes:"%d Minuten",hour:"etwa einer Stunde",hours:"%d Stunden",day:"etwa einem Tag",days:"%d Tagen",month:"etwa einem Monat",months:"%d Monaten",year:"etwa einem Jahr",years:"%d Jahren"};break;case"fr_FR":jQuery.timeago.settings.strings={prefixAgo:"il y a",prefixFromNow:"d'ici",seconds:"moins d'une minute",minute:"environ une minute",minutes:"environ %d minutes",hour:"environ une heure",hours:"environ %d heures",day:"environ un jour",days:"environ %d jours",month:"environ un mois",months:"environ %d mois",year:"un an",years:"%d ans"};break;case"pt_PT":jQuery.timeago.settings.strings={suffixAgo:"atrás",suffixFromNow:"a partir de agora",seconds:"menos de um minuto",minute:"cerca de um minuto",minutes:"%d minutos",hour:"cerca de uma hora",hours:"cerca de %d horas",day:"um dia",days:"%d dias",month:"cerca de um mês",months:"%d meses",year:"cerca de um ano",years:"%d anos"}}}},Utils={linkify:function(e){if(e===undefined||e===null)return"";var t,n,r,i;return replacedText=e,replacedText=replacedText.replace(/&/g,"&amp;"),replacedText=replacedText.replace(/</g,"&lt;"),replacedText=replacedText.replace(/>/g,"&gt;"),n=/(\b(http?|https):\/\/[\-A-Z0-9+&@#\/%?=~_|!:,.;]*[\-A-Z0-9+&@#\/%=~_|])/gim,replacedText=replacedText.replace(n,'<a href="$1" target="_blank">$1</a>'),r=/(^|[^\/])(www\.[\S]+(\b|$))/gim,replacedText=replacedText.replace(r,'$1<a href="http://$2" target="_blank">$2</a>'),replacedText},getArtistAndTrackNames:function(e){if(e.track&&e.artist)return{track:e.track,artist:e.artist};var t=e.title.toLowerCase(),n=!1,r=["(official video)","official video","p/v","m/v"];$.each(r,function(e,n){t=t.replace(n,"")}),t.replace("  ",""),t.replace("   ","");var i=t.split("-"),s=t.match(/(.*)'(.*)'/),o=t.match(/(.*)"(.*)"/);return i.length>=2?n={artist:$.trim(i[0]),track:$.trim(i[1])}:s&&s.length===3?n={artist:$.trim(s[1]),track:$.trim(s[2])}:o&&o.length===3?n={artist:$.trim(o[1]),track:$.trim(o[2])}:e.artist&&(n={artist:e.artist,track:$.trim(e.title)}),e.echonestArtist&&n.track===e.echonestArtist.toLowerCase()&&(n.track=n.artist,n.artist=e.echonestArtist),n},escape:function(e){return e=e.replace("<","&lt;"),e=e.replace(">","&gt;"),e=e.replace('"',"&quot;"),e},shorten:function(e,t){if(e===null)return"";var n=e;return n.length>t&&(n=n.substr(0,t-3),n+="..."),n},extractArtist:function(e){if(e){var t=e.split("-");if(t.length>1)return $.trim(t[0])}return!1},deSelectSelectedVideos:function(){var e;for(e=0;e<selectedVideoElements.length;e+=1)selectedVideoElements[e].removeClass("selected")},addFollowing:function(e){myFollowings.push(e)},closeAnyOpenArrowPopup:function(e){$("#arrow-popup-blocker").click()},removeFollowing:function(e){var t=[];$.each(myFollowings,function(n,r){r.id!==e&&t.push(r)}),myFollowings=t},isFollowingUser:function(e){var t=!1;return $.each(myFollowings,function(n,r){if(r.id===e)return t=!0,!1}),t},showModalBox:function(e){var t=new ModalBox;return t.setMessage(e),t.setCanBeClosed(!0),t.show(),t},openLink:function(e){window.open(e)}},mousedown=!1,mousedrag=!1,sourceElem=null,dragElem=null,dropCallbacks=[],mouseDraggedCallback=null;$(window).mousemove(function(e){!mousedrag&&mousedown&&($(e.target).hasClass("draggable")||$(e.target).parents(".draggable").length>0)&&(mousedrag=!0,dragStarted(e)),mousedrag&&mouseDragged(e)}),$(window).mouseup(function(e){$("body").removeClass("mousedrag"),mousedown=!1,mousedrag&&(mousedrag=!1,dragEnded(e))}),$(".draggable").live("mousedown",function(e){if($(e.target).hasClass("draggable")||$(e.target).parents(".draggable"))mousedown=!0,e.preventDefault()}),$(window).keyup(function(e){e.keyCode===27&&dragAborted()}),mouseDraggedCallback=function(e,t){e.attr("id")==="results-container"&&t.hasClass("video")&&$("#results-container .results.active .video:last").addClass("insert-after")},registerDropCallback(function(e,t,n){var r,i,s,o,u;n.hasClass("playlists")&&t.hasClass("video")&&(s=playlistManager.getCurrentlySelectedPlaylist(),u=t.parent().find(".video.selected"),o=s.getTrackList().find(".video:last"),i=t.index(),r=o.index(),$.each(u,function(e,t){s!==undefined&&(s.moveVideo(i,r+1),$(t).detach().appendTo(s.getTrackList()))}),playlistManager.save())}),registerDropCallback(function(e,t,n){if(n.hasClass("playlistElem")&&t.hasClass("video")){var r=n.data("model");$.each(t,function(e,t){t=$(t),t.hasClass("video")&&(r.addVideo(t.data("model")),t.removeClass("selected"))}),playlistManager.save()}}),registerDropCallback(function(e,t,n){if(n.hasClass("playlistElem")&&t.attr("id")==="info"){var r=n.data("model");r.addVideo(t.data("model")),playlistManager.save()}}),registerDropCallback(function(e,t,n){if(n.hasClass("video")&&t.hasClass("video")&&t.data("model")!==n.data("model")){var r=playlistManager.getCurrentlySelectedPlaylist(),i=t.parent().find(".video.selected");$.each(i,function(e,i){r!==undefined&&(r.moveVideo(t.index(),n.index()),$(i).detach().insertBefore(n))}),playlistManager.save()}}),$(window).keyup(function(e){e.keyCode===27&&$("#contextmenu").length&&$("#context-menu-blocker, #contextmenu").remove()});var LoadingBar={$elem:undefined,init:function(){LoadingBar.$elem=$("#loading")},show:function(){LoadingBar.$elem.fadeIn(200)},hide:function(){LoadingBar.$elem.fadeOut(200)},error:function(){LoadingBar.$elem.addClass("error"),LoadingBar.$elem.fadeOut(400,function(){LoadingBar.$elem.removeClass("error")})}},Volume={isDragging:!1,init:function(){$("#bottom .volume").mousedown(function(e){Volume.setVolume(e)}),$("#bottom .volume .slider .knob").mousedown(function(e){Volume.startDrag(e)}),$(window).mouseup(function(e){Volume.stopDrag(e)}),$(window).mousemove(function(e){Volume.onDrag(e)})},startDrag:function(e){Volume.isDragging=!0},stopDrag:function(e){Volume.isDragging=!1},onDrag:function(e){if(!Volume.isDragging)return;Volume.setVolume(e)},setVolume:function(e){var t=$("#bottom .volume").width(),n=e.pageX-$("#bottom .volume .slider").offset().left;n<0&&(n=0),n>t&&(n=t),player.setVolume(n/t*100),$("#bottom .volume .slider").css({width:n})},updateUI:function(e){var t=$("#bottom .volume").width(),n=t*e/100;$("#bottom .volume .slider").css({width:n})}},Search={searchTimeoutHandle:null,currentQuery:"",alternatives:undefined,lastVideosSearchQuery:undefined,lastPlaylistsSearchQuery:undefined,lastSoundCloudTracksQuery:undefined,itemsPerPage:30,lastQueries:{},tabs:null,$rightView:null,init:function(){Search.$rightView=$("#right .search"),Search.tabs=new Tabs(Search.$rightView,{"youtube-videos":Search.searchCurrentQuery,"soundcloud-tracks":Search.searchCurrentQuery,"officialfm-tracks":Search.searchCurrentQuery,"youtify-playlists":Search.searchCurrentQuery,"youtify-users":Search.searchCurrentQuery}),$("#top .search input").keyup(function(e){$("#left, #right").removeClass("focused"),$("#top .search").addClass("focused");var t,n=[9,16,17,18,37,38,39,40];for(t=0;t<n.length;t+=1)if(e.keyCode===n[t])return;var r=700,i=$.trim($("#top .search input").val());Search.searchTimeoutHandle&&clearTimeout(Search.searchTimeoutHandle),e.keyCode===13?Search.search(i):Search.searchTimeoutHandle=setTimeout(function(){Search.search(i)},r)}),function(){var e=$("#right .search"),t;$("#right .search").scroll(function(n){t&&clearTimeout(t),t=setTimeout(function(){var t=$("#right .search .pane.selected");e.scrollTop()>=t.height()-e.height()&&t.hasClass("has-more")&&Search.search(Search.currentQuery,!0)},100)})}(),$("#top .search button").click(function(){Search.search($.trim($("#top .search input").val()))}),EventSystem.addEventListener("video_started_playing_successfully",function(){Search.alternatives=undefined})},searchCurrentQuery:function(){Search.search(Search.currentQuery)},show:function(){Menu.deSelect(),Search.$rightView.show(),history.pushState(null,null,encodeURI("/search?q="+Search.currentQuery))},search:function(e,t){if(e.length===0)return;var n=null,r=null,i=null,s=null,o=null;Search.currentQuery=e,Search.show(),Search.tabs.$selectedTab?s=Search.tabs.$selectedTab.attr("rel"):s="youtube-videos";if(Search.lastQueries.hasOwnProperty(s)&&Search.lastQueries[s]===e&&!t)return;Search.lastQueries[s]=e,Search.tabs.$selectedTab||Search.tabs.select(s),t||Search.tabs.$selectedPane.html(""),i=t?Search.tabs.$selectedPane.data("results-count")+1:1,r=Search.tabs.$selectedPane.data("results-count")||0;switch(s){case"youtube-videos":n="http://gdata.youtube.com/feeds/api/videos?callback=?",o={alt:"json-in-script","max-results":Search.itemsPerPage,"start-index":i,format:5,q:e},LoadingBar.show(),$.getJSON(n,o,function(e){var t=Search.getVideosFromYouTubeSearchData(e);$.each(t,function(e,t){t&&t.createListView().appendTo(Search.tabs.$selectedPane)}),Search.tabs.$selectedPane.data("results-count",r+t.length),t.length>=Search.itemsPerPage?Search.tabs.$selectedPane.addClass("has-more"):Search.tabs.$selectedPane.removeClass("has-more"),LoadingBar.hide()});break;case"soundcloud-tracks":n="https://api.soundcloud.com/tracks.json",o={q:e,limit:Search.itemsPerPage,filter:"streamable",offset:i,client_id:SOUNDCLOUD_API_KEY},LoadingBar.show(),$.getJSON(n,o,function(e){var t=Search.getVideosFromSoundCloudSearchData(e);$.each(t,function(e,t){t&&t.createListView().appendTo(Search.tabs.$selectedPane)}),Search.tabs.$selectedPane.data("results-count",r+t.length),t.length>=Search.itemsPerPage?Search.tabs.$selectedPane.addClass("has-more"):Search.tabs.$selectedPane.removeClass("has-more"),LoadingBar.hide()});break;case"officialfm-tracks":n="http://api.official.fm/search/tracks/"+escape(e)+"/paginate",o={format:"json",per_page:30,page:Math.ceil(i/30),key:OFFICIALFM_API_KEY},LoadingBar.show(),$.getJSON(n,o,function(e){var t=Search.getVideosFromOfficialfmSearchData(e.tracks);$.each(t,function(e,t){t&&t.createListView().appendTo(Search.tabs.$selectedPane)}),Search.tabs.$selectedPane.data("results-count",r+t.length),e.current>=e.per_page?Search.tabs.$selectedPane.addClass("has-more"):Search.tabs.$selectedPane.removeClass("has-more"),LoadingBar.hide()});break;case"youtify-users":n="/api/search/users",o={q:e,per_page:30,page:Math.ceil(i/30)},LoadingBar.show(),$.get(n,o,function(e){var t=e;$.each(t,function(e,t){(new User(t)).getSmallView().appendTo(Search.tabs.$selectedPane)}),Search.tabs.$selectedPane.data("results-count",r+t.length),LoadingBar.hide()});break;case"youtify-playlists":n="/api/search/playlists",o={q:e,per_page:30,page:Math.ceil(i/30)},LoadingBar.show(),$.get(n,o,function(e){var t=e;$.each(t,function(e,t){(new Playlist(t.title,t.videos,t.remoteId,t.owner,t.isPrivate)).getSearchView().appendTo(Search.tabs.$selectedPane)}),Search.tabs.$selectedPane.data("results-count",r+t.length),LoadingBar.hide()})}},getVideosFromSoundCloudSearchData:function(e){return ret=[],$.each(e,function(e,t){var n=t.purchase_url?[t.purchase_url]:null;ret.push(new Video({videoId:t.id,title:t.title,duration:t.duration,buyLinks:n,uploaderUsername:t.user.permalink,type:"soundcloud",artworkURL:t.artwork_url}))}),ret},getVideosFromOfficialfmSearchData:function(e){return ret=[],$.each(e,function(e,t){var n=t.purchase_url?[t.buy_url]:null;ret.push(new Video({videoId:t.id,title:t.title,duration:t.length*1e3,buyLinks:n,type:"officialfm"}))}),ret},getVideosFromYouTubeSearchData:function(e){var t=[];return e.feed.entry===undefined?t:($.each(e.feed.entry,function(e,n){if(n.media$group.media$content===undefined||n.media$group.media$content===null){t.push(null);return}var r=n.id.$t,i=n.title.$t,s;r.match("videos/(.*)$")?s=r.match("videos/(.*)$")[1]:s=n.media$group.yt$videoid.$t;var o=new Video({videoId:s,title:i,uploaderUsername:n.author[0].name.$t,type:"youtube",artworkURL:n.media$group.media$thumbnail.length>1?n.media$group.media$thumbnail[1].url:null});t.push(o)}),t)},getPlaylistsFromYouTubeSearchData:function(e){var t=[];return e.feed.entry===undefined?t:($.each(e.feed.entry,function(e,n){var r=n.yt$playlistId.$t,i=n.title.$t,s=n.yt$countHint.$t,o=new YouTubePlaylist(r,i,s);t.push(o)}),t)},findAlternative:function(e,t){console.log("finding alternative for "+e.title),Search.alternatives===undefined?Search.findAlternativesToVideo(e,function(e){Search.alternatives=e,e.length?t(Search.alternatives.shift()):t(!1)}):Search.alternatives.length?t(Search.alternatives.shift()):t(!1)},findAlternativesToVideo:function(e,t){var n=[],r="http://gdata.youtube.com/feeds/api/videos?callback=?",i={alt:"json-in-script","max-results":10,"start-index":1,format:5,q:e.title};$.getJSON(r,i,function(e){if(e.feed.entry===undefined){t(n);return}n=Search.getVideosFromYouTubeSearchData(e,!0),t(n)})}},YouTubePlaylist=function(e,t,n,r){var i=this;i.id=e,i.title=t,i.view=null,i.videos=[],i.videoCountHint=n,i.videoOnPlayCallback=r,i.createView=function(){var e=$('<td class="space"></td>'),t=function(e){i.viewSelect(e),e.stopPropagation()},n=function(e){i.togglePlaylistView(),e.stopPropagation()};i.view=$("<tr/>").addClass("playlist").click(t).data("model",i),$('<td class="playlist"></td>').click(n).appendTo(i.view),e.clone().appendTo(i.view);var r=$('<td class="title"/>').click(t).text(i.title).appendTo(i.view);return $('<table class="videos"/>').appendTo(r).hide(),e.clone().appendTo(i.view),$('<td class="videoCountHint"/>').text(i.videoCountHint).appendTo(i.view),i.view.dblclick(n),r.dblclick(n),i.view},i.viewSelect=function(e){i.view.siblings().removeClass("selected"),i.view.addClass("selected")},i.togglePlaylistView=function(){var e=i.view.find(".videos");i.videos.length?e.toggle():(i.view.addClass("loading"),e.show(),i.loadVideos())},i.loadVideos=function(){var e=i.videos.length+1,t="http://gdata.youtube.com/feeds/api/playlists/"+i.id+"?start-index="+e+"&max-results=50&v=2&alt=json&callback=?",n=i.view.find(".videos");$.getJSON(t,{},function(e){if(e.feed.entry&&e.feed.entry.length>0){var t=Search.getVideosFromYouTubeSearchData(e);i.videos=$.merge(i.videos,t),$.each(t,function(e,t){t&&(t.onPlayCallback=i.videoOnPlayCallback,t.createListView().appendTo(n))}),i.loadVideos()}else i.view.removeClass("loading")})}},Queue={manualList:[],autoList:[],manualPlayIndex:null,autoPlayIndex:null,$rightView:null,$tracklist:null,menuItem:null,init:function(){this.$rightView=$("#right .queue"),this.$tracklist=$("#right .queue .tracklist"),this.menuItem=new MenuItem({cssClasses:["queue"],title:TranslationSystem.get("Play Queue"),$contentPane:this.$rightView,onSelected:function(){},translatable:!0}),Menu.getGroup("misc").addMenuItem(this.menuItem)},addManual:function(e){Queue.manualList.push(e),Queue.updateView()},setAutoQueue:function(e){Queue.autoPlayIndex=0,Queue.autoList=e,Queue.updateView()},manualPlay:function(e){return console.log("manual "+e),Queue.manualList.length===0?!1:e<0||e>Queue.manualList.length-1?!1:(Queue.manualPlayIndex=e,Queue.manualList[Queue.manualPlayIndex].play(),Queue.autoPlayIndex=null,Queue.updateView(),!0)},autoPlay:function(e){return console.log("auto "+e),Queue.autoList.length===0?!1:e<0||e>Queue.autoList.length-1?!1:(Queue.autoPlayIndex=e,Queue.autoList[Queue.autoPlayIndex].play(),Queue.updateView(),!0)},playNext:function(){return Queue.manualList.length+Queue.autoList.length===0?!1:Queue.manualList.length>0&&Queue.manualPlayIndex===null?Queue.manualPlay(0):Queue.manualList.length>0&&Queue.manualPlayIndex+1<Queue.manualList.length?Queue.manualPlay(Queue.manualPlayIndex+1):Queue.autoList.length>0&&Queue.autoPlayIndex===null?Queue.autoPlay(0):Queue.autoList.length>0&&Queue.autoPlayIndex+1<Queue.autoList.length?Queue.autoPlay(Queue.autoPlayIndex+1):!1},playPrev:function(){return Queue.manualList.length+Queue.autoList.length===0?!1:Queue.autoPlayIndex!==null&&Queue.autoPlayIndex>0?Queue.autoPlay(Queue.autoPlayIndex-1):Queue.autoPlayIndex!==null&&Queue.autoPlayIndex===0?Queue.manualPlay(Queue.manualList.length-1):Queue.manualPlayIndex!==null&&Queue.manualPlayIndex>0?Queue.manualPlay(Queue.manualPlayIndex-1):!1},updateView:function(){var e=this.$tracklist;e.html(""),$.each(Queue.manualList,function(t,n){var r=n.listView.clone(),i=function(){Queue.manualPlay(t)};r.removeClass("selected").removeClass("playing"),t===Queue.manualPlayIndex&&Queue.autoPlayIndex===null&&r.addClass("playing"),r.dblclick(i),r.find(".play").click(i),r.bind("contextmenu",showResultsItemContextMenu),r.click(function(e){n.listViewSelect(e,r)}),r.find(".menu").click(function(e){showResultsItemContextMenu(e,r)}),Queue.manualPlayIndex!==null&&t-Queue.manualPlayIndex<-2&&r.hide(),r.appendTo(e)}),$.each(Queue.autoList,function(t,n){var r=n.listView.clone(),i=function(){Queue.autoPlay(t)};r.removeClass("selected").removeClass("playing"),t===Queue.autoPlayIndex&&r.addClass("playing"),r.dblclick(i),r.find(".play").click(i),r.bind("contextmenu",showResultsItemContextMenu),r.click(function(e){n.listViewSelect(e,r)}),r.find(".menu").click(function(e){showResultsItemContextMenu(e,r)}),r.data("model",n),r.addClass("draggable"),r.appendTo(e)})},addSiblingsToPlayorder:function(e){if(e===undefined)return;var t=[];$("#bottom .shuffle").hasClass("on")?($(e).siblings(".video").each(function(e,n){t.push($(n).data("model"))}),$.shuffle(t)):$(e).nextAll(".video").each(function(e,n){t.push($(n).data("model"))}),t.unshift($(e).data("model")),Queue.setAutoQueue(t)}},PlaylistView={createPlaylistHeader:function(e,t){var n=$('<div class="playlist-header"/>'),r=$('<div class="info"/>'),i=$('<span class="translatable button subscribe"/>').text(TranslationSystem.get("Subscribe")),s=$('<span class="translatable button unsubscribe"/>').text(TranslationSystem.get("Unsubscribe"));return $('<span class="title link"/>').text(e.title).click(function(){e.remoteId?history.pushState(null,null,e.getUrl()):history.pushState(null,null,"/"),PlaylistView.loadPlaylistView(e)}).appendTo(n),e.owner&&e.owner.getSmallView().appendTo(r),r.append($('<span class="nr"/>').text(e.videos.length)),e.remoteId!==null&&!e.isPrivate&&$('<span class="subscribers"/>').text(e.followers.length).click(function(){PlaylistView.displaySubscribersPopupForPlaylist($(this),e)}).appendTo(r),i.click(function(){e.subscribe(),$(this).hide(),$(this).next().show()}),s.click(function(){playlistManager.deletePlaylist(e),$(this).hide(),$(this).prev().show()}),UserManager.isLoggedIn()&&e.owner&&e.owner.id!==UserManager.currentUser.id&&(r.append(i),r.append(s)),e.isSubscription?i.hide():s.hide(),t&&e.remoteId!==null&&UserManager.currentUser.id===e.owner.id&&PlaylistView.createPrivacyToggleButton(e).appendTo(r),r.appendTo(n),n},createSmallPlaylistView:function(e,t){var n=0,r=$('<div class="playlist-box"/>'),i=PlaylistView.createPlaylistHeader(e,t),s=$('<div class="tracklist-container minimized"/>'),o=$('<table class="tracklist"/>');for(n=0;n<Math.min(e.videos.length,5);n+=1)if(e.videos[n]){var u=new Video({title:e.videos[n].title,type:e.videos[n].type,videoId:e.videos[n].videoId,duration:e.videos[n].duration});u.createListView().addClass("droppable").addClass("draggable").appendTo(o)}return r.append(i),s.append(o),r.append(s),r},displaySubscribersPopupForPlaylist:function(e,t){var n=$("#playlist-subscribers-popup").html("");$.each(t.followers,function(e,t){n.append((new User(t)).getSmallView())}),n.find(".user").click(function(){$("#arrow-popup-blocker").click()}),e.arrowPopup("#playlist-subscribers-popup")},updatePlaylistBar:function(e){$("#right > .playlists .playlist-header").replaceWith(PlaylistView.createPlaylistHeader(e,!0))},createPrivacyToggleButton:function(e){var t=$('<span class="privacy translatable"/>');return e.isPrivate?(t.addClass("private"),t.text(TranslationSystem.get("Private"))):(t.addClass("public"),t.text(TranslationSystem.get("Public"))),t.click(function(){e.isPrivate=!e.isPrivate,e.isPrivate?(t.removeClass("public"),t.addClass("private"),t.text(TranslationSystem.get("Private"))):(t.removeClass("private"),t.addClass("public"),t.text(TranslationSystem.get("Public"))),e.synced=!1,LoadingBar.show(),e.sync(function(){LoadingBar.hide()})}),t},loadPlaylistView:function(e){e.getMenuItem().isSelected()&&player.currentVideo&&player.currentVideo.listView&&player.currentVideo.scrollTo(),$("#right > div").hide(),$("#right > .playlists .tracklist").hide(),$("#right > .playlists").show();var t=e.getTrackList();t.show(),PlaylistView.updatePlaylistBar(e),t.find(".video").length!==e.videos.length&&(t.html(""),$.each(e.videos,function(n,r){r&&($video=r.createListView(),$video.addClass("droppable"),$video.addClass("draggable"),e.isSubscription||($video.data("additionalMenuButtons",[{title:TranslationSystem.get("Delete"),cssClass:"delete",args:$video,callback:PlaylistView.deleteVideoButtonClicked}]),$video.addClass("reorderable")),$video.appendTo(t))}))},syncPlaylistButtonClicked:function(e){var t=playlistManager.getCurrentlySelectedPlaylist();console.log("syncing playlist "+t.title),t.sync(function(){PlaylistView.updatePlaylistBar(t),playlistManager.save(),t.getMenuView().addClass("remote"),history.pushState(null,null,t.getUrl())})},deleteVideoButtonClicked:function(e){var t=playlistManager.getCurrentlySelectedPlaylist(),n=e.parent().find(".video.selected");$.each(n,function(e,n){$video=$(n),t.deleteVideo($video.index()),$video.remove()}),playlistManager.save()}};$(window).keydown(function(e){var t=null;if($("input, textarea").is(":focus"))return;switch(e.keyCode){case 32:player.playPause(),e.preventDefault();break;case 27:Utils.closeAnyOpenArrowPopup(),$(".modalbox").click(),$("#context-menu-blocker").mousedown(),player.fullScreenOff(),e.preventDefault();break;case 13:$("#results li.selected").dblclick();break;case 37:(e.ctrlKey||e.metaKey)&&player.prev(),e.shiftKey&&player.seek(-5);break;case 38:e.ctrlKey||e.metaKey?player.setRelativeVolume(10):(t=$("#right .pane.selected .video.selected:first").prev().data("model"),t&&(e.shiftKey?t.listViewSelect(e):t.listViewSelect())),e.preventDefault();break;case 39:(e.ctrlKey||e.metaKey)&&player.next(),e.shiftKey&&player.seek(5);break;case 40:e.ctrlKey||e.metaKey?player.setRelativeVolume(-10):(t=$("#right .pane.selected .video.selected:last").next().data("model"),t&&(e.shiftKey?t.listViewSelect(e):t.listViewSelect())),e.preventDefault();break;case 65:return(e.ctrlKey||e.metaKey)&&$("#results-container li.selected").siblings().addClass("selected"),e.preventDefault(),!1}});var Notifications={init:function(){$(".notifications .close").live("click",function(e){var t=$(this).parent();t.addClass("hidden"),setTimeout(function(){t.remove()},1e3)}),EventSystem.addEventListener("video_info_fetched",function(e){Notifications.append(e.title)})},append:function(e){if(window.webkitNotifications&&window.webkitNotifications.checkPermission()<2)Notifications._webkitAppend(e);else{var t=new Settings,n=$("<li/>"),r=$('<div class="content"/>').text(e),i=$('<span class="close"/>').text("X");r.appendTo(n),i.appendTo(n),n.appendTo("#top .notifications"),setTimeout(function(){n.find(".close").click()},t.announceTimeout)}},_webkitAppend:function(e){var t=function(e){try{var t=new Settings,n=window.webkitNotifications.createNotification("/images/logo/logo_32x32.png","Youtify",e);n.show(),setTimeout(function(){n.cancel()},t.announceTimeout)}catch(r){console.log(r.message)}};window.webkitNotifications&&(window.webkitNotifications.checkPermission()===1?window.webkitNotifications.requestPermission(function(){t(e)}):t(e))}},URIManager={initialPopStateHasRun:!1,init:function(){window.addEventListener("popstate",function(e){var t=navigator.userAgent.toLowerCase().indexOf("chrome")>-1;if(t&&!URIManager.initialPopStateHasRun){URIManager.initialPopStateHasRun=!0;return}URIManager.loadState()}),URIManager.loadWarnings(),URIManager.loadState()},loadWarnings:function(){window.top!==window.self&&Notifications.append("This address is not affiliated with Youtify. Always use www.youtify.com")},loadState:function(){var e=[["/search",function(e){var t="";location.search&&(t=decodeURI(location.search.match("q=(.*)")[1])),$("#top .search input").val(t).keyup()}],["/tracks/(.*)/(.*)",function(e){vid=new Video({videoId:e[2],type:e[1]}),player.initialized?player.play(vid):EventSystem.addEventListener("player_manager_initialized",function(){player.play(vid)}),EventSystem.addEventListener("video_info_fetched",function(e){var t=!1;t||(t=!0,vid.title=e.title,vid.createListView(),Queue.setAutoQueue([vid]))}),$("#left .queue").mousedown()}],["/soundcloud/(.*)",function(e){ExternalUserPage.loadSoundCloudUser(e[1])}],["/youtube/(.*)",function(e){ExternalUserPage.loadYouTubeUser(e[1])}],["/playlists/(.*)",function(e){loadPlaylist(e[1])}],["/profile",function(e){UserManager.loadCurrentUser()}],["/users/(.*)",function(e){UserManager.loadProfile(e[1])}],["/(.+)",function(e){UserManager.loadProfile(e[1])}],["/",function(e){HomeScreen.menuItem.select()}]],t;for(t=0;t<e.length;t+=1){var n=e[t],r=location.pathname.match(n[0]);if(r){n[1](r);break}}}},Ping={init:function(){setInterval(function(){$.get("/ping",function(e){})},6e5)}},Uploader={loadVideosFromURI:function(e){var t=e+"/uploads?callback=?",n={alt:"json-in-script",v:2};$("#left .search").data("model").select(),$("#right .search .tabs .youtube.videos").data("model").select(),$.getJSON(t,n,function(e){var t=$("#right .pane.youtube.videos");if(e.feed.entry===undefined)return;t.html(""),$.each(e.feed.entry,function(e,n){var r=n.id.$t,i=r.match("video:(.*)$")[1],s=n.title.$t,o=(new Video({videoId:i,title:s,type:"youtube"})).createListView();o.appendTo(t)})})}},SpotifyImporterPopup={init:function(){$("#spotify-importer").bind("contextmenu",function(e){e.stopPropagation()}).click(function(e){e.stopPropagation()}),$("#spotify-importer .instructions").click(function(){player.play(new Video({videoId:"uLG5rWWf_rg",type:"youtube"}))});var e=new SpotifyImporter;$("#spotify-importer .cancel").click(function(){e.cancel(),$("#spotify-importer").hide(),$("#blocker, .arrow").remove()}),$("#spotify-importer .start").click(function(){var t=$("#left .playlists ul .selected"),n=t.data("model");e.start($("#spotify-importer textarea").val(),n,function(){$("#spotify-importer .added").text(e.added),$("#spotify-importer .max").text("/"+e.max),PlaylistView.loadPlaylistView(n)},function(){e.cancel(),$("#spotify-importer").hide(),$("#blocker, .arrow").remove()})})}},Activities={getSignupActivity:function(){return $('<div class="activity">'+TranslationSystem.get("You joined Youtify")+"</div>")},getIncomingSubscribeActivityView:function(e,t){var n='<span class="user small link"><img src="'+e.smallImageUrl+'"/><span clas="name">'+Utils.escape(e.displayName)+"</span></span>",r='<span class="link playlist">'+Utils.escape(t.title)+"</span>",i=$('<div class="activity">'+TranslationSystem.get("$user subscribed to your playlist $playlist",{$playlist:r,$user:n})+"</div>");return i.find(".link.user").click(e.goTo),i.find(".link.playlist").click(t.goTo),i},getOutgoingSubscribeActivityView:function(e){var t='<span class="user small link"><img src="'+e.owner.smallImageUrl+'"/><span clas="name">'+Utils.escape(e.owner.displayName)+"</span></span>",n='<span class="link playlist">'+Utils.escape(e.title)+"</span>",r=$('<div class="activity">'+TranslationSystem.get("You subscribed to $playlist by $user",{$playlist:n,$user:t})+"</div>");return r.find(".link.user").click(e.owner.goTo),r.find(".link.playlist").click(e.goTo),r},getIncomingExternalSubscribeActivity:function(e,t){console.log(e,t);var n='<span class="user small link"><img src="'+e.smallImageUrl+'"/><span clas="name">'+Utils.escape(e.displayName)+"</span></span>",r='<span class="link external-user">'+Utils.escape(t.username)+"</span>",i=$('<div class="activity">'+TranslationSystem.get("$user subscribed to $externalUser",{$externalUser:r,$user:n})+"</div>");return i.find(".link.user").click(e.goTo),i.find(".link.external-user").click(t.goTo),i},getOutgoingExternalSubscribeActivity:function(e){var t='<span class="link external-user">'+Utils.escape(e.username)+"</span>",n=$('<div class="activity">'+TranslationSystem.get("You subscribed to $externalUser",{$externalUser:t})+"</div>");return n.find(".link.external-user").click(e.goTo),n},getOutgoingFollowActivity:function(e){var t='<span class="user small link"><img src="'+e.smallImageUrl+'"/><span class="name">'+Utils.escape(e.displayName)+"</span></span>",n=$('<div class="activity">'+TranslationSystem.get("You started following $user",{$user:t})+"</div>");return n.find(".link.user").click(e.goTo),n},getIncomingFollowActivity:function(e){var t='<span class="user small link"><img src="'+e.smallImageUrl+'"/><span class="name">'+Utils.escape(e.displayName)+"</span></span>",n=$('<div class="activity">'+TranslationSystem.get("$user started following you",{$user:t})+"</div>");return n.find(".link.user").click(e.goTo),n},getOutgoingFlattrActivity:function(e){var t="https://flattr.com/t/"+e.thing_id,n=e.thing_title||t,r='<a class="thing link" href="'+t+'" target="_blank">'+n+"</a>";return $('<div class="activity">'+TranslationSystem.get("You flattred $thing",{$thing:r})+"</div>")},getIncomingFlattrActivity:function(e,t){var n="https://flattr.com/t/"+t.thing_id,r=t.thing_title||n,i='<a class="thing link" href="'+n+'" target="_blank">'+r+"</a>",s='<span class="user small link"><img src="'+e.smallImageUrl+'"/><span class="name">'+Utils.escape(e.displayName)+"</span></span>",o=$('<div class="activity">'+TranslationSystem.get("$user flattred $thing",{$user:s,$thing:i})+"</div>");return o.find(".link.user").click(e.goTo),o},getActivityElem:function(e){var t=$('<div class="activity"></div>'),n=null,r=null,i=null,s=null,o=null;switch(e.verb){case"follow":n=new User(JSON.parse(e.actor)),r=new User(JSON.parse(e.target)),r.id===UserManager.currentUser.id?t=Activities.getIncomingFollowActivity(n):n.id===UserManager.currentUser.id&&(t=Activities.getOutgoingFollowActivity(r));break;case"subscribe":n=new User(JSON.parse(e.actor)),i=JSON.parse(e.target),i=new Playlist(i.title,i.videos,i.remoteId,i.owner,i.isPrivate),i.owner.id===UserManager.currentUser.id?t=Activities.getIncomingSubscribeActivityView(n,i):n.id===UserManager.currentUser.id&&(t=Activities.getOutgoingSubscribeActivityView(i));break;case"external_subscribe":n=new User(JSON.parse(e.actor)),s=new ExternalUserSubscription(JSON.parse(e.target)),n.id===UserManager.currentUser.id?t=Activities.getOutgoingExternalSubscribeActivity(s):t=Activities.getIncomingExternalSubscribeActivity(n,s);break;case"signup":t=Activities.getSignupActivity();break;case"flattr":n=new User(JSON.parse(e.actor)),o=JSON.parse(e.target),n.id===UserManager.currentUser.id?t=Activities.getOutgoingFlattrActivity(o):t=Activities.getIncomingFlattrActivity(n,o)}return t.append('<span class="timestamp"> '+jQuery.timeago(new Date(Number(e.timestamp*1e3)))+"</span>"),t},loadNotificationsPopup:function(){var e=$("#activities-popup ul");e.html(""),LoadingBar.show(),$.get("/api/users/"+UserManager.currentUser.id+"/activities?type=incoming&verbs=follow,subscribe&count=50",function(t){$.each(t,function(t,n){e.append(Activities.getActivityElem(n))}),LoadingBar.hide()})}},Menu={$view:null,selectedMenuItem:null,playingMenuItem:null,groups:{},init:function(){var e=this;this.$view=$("#left .menu"),$.each(this.$view.find(".group"),function(t,n){n=$(n),e.groups[n.attr("rel")]=new MenuItemGroup(n)}),$("#left .playlists .new span").click(this.newPlaylistClick),$("#left .playlists .new input").keyup(this.newPlaylistNameKeyUp),$("#left .playlists .new input").blur(this.newPlaylistNameBlur)},deSelect:function(){this.selectedMenuItem&&this.selectedMenuItem.deSelect()},getGroup:function(e){if(this.groups.hasOwnProperty(e))return this.groups[e];throw"Menu has no group named "+e},newPlaylistClick:function(){$(this).hide(),$("#left .playlists .new input").show().focus().select().val("")},newPlaylistNameBlur:function(){$("#left .playlists .new span").show(),$(this).hide()},newPlaylistNameKeyUp:function(e){var t,n,r=[];switch(e.keyCode){case 13:$("#left .playlists .new input").hide(),$("#left .playlists .new span").show(),t=$.trim($(this).val());if(!(t.length>0&&t.length<50))return;n=new Playlist($(this).val(),r),playlistManager.addPlaylist(n),Menu.getGroup("playlists").addMenuItem(n.getMenuItem()),UserManager.isLoggedIn()?n.createNewPlaylistOnRemote(function(){playlistManager.save(),n.getMenuItem().$view.addClass("remote")}):playlistManager.save(),$(this).val("");break;case 27:$("#left .playlists .new input").hide(),$("#left .playlists .new span").show(),$(this).val("")}e.stopPropagation()}},Timeline={hasThrownAlmostDoneEvent:!1,init:function(){$("#bottom .timeline").mousedown(function(e){Timeline.manualUpdate(e)}),$("#bottom .timeline .slider .knob").mousedown(function(e){Timeline.startDrag(e)}),$(window).mouseup(function(e){Timeline.stopDrag(e)}),$(window).mousemove(function(e){Timeline.onDrag(e)})},isDragging:!1,updateHandle:null,startDrag:function(e){Timeline.isDragging=!0},stopDrag:function(e){Timeline.isDragging&&(Timeline.stop(),Timeline.isDragging=!1,Timeline.manualUpdate(e),Timeline.start())},onDrag:function(e){if(!Timeline.isDragging)return;Timeline.manualUpdate(e)},start:function(){Timeline.hasThrownAlmostDoneEvent=!1,$("#bottom .timeline .knob").show(),Timeline.updateHandle===null&&(Timeline.updateHandle=setInterval(Timeline.update,100))},manualUpdate:function(e){var t=$("#bottom .timeline").width(),n=e.pageX-$("#bottom .timeline .slider").offset().left,r=null,i=player.getTotalPlaybackTime();n<0&&(n=0),n>t&&(n=t),r=n/t*i,$("#bottom .timeline-wrapper .position").html(Math.floor(r/60)+":"+(Math.floor(r%60)<10?"0":"")+Math.floor(r%60)),$("#bottom .timeline-wrapper .length").html(Math.floor(i/60)+":"+(Math.floor(i%60)<10?"0":"")+Math.floor(i%60)),$("#bottom .timeline-wrapper .slider").width(r/i*$("#bottom .timeline").width()),Timeline.isDragging||player.seekTo(r)},update:function(e){if(Timeline.isDragging)return;var t=player.getCurrentPlaybackTime(),n=player.getTotalPlaybackTime();!Timeline.hasThrownAlmostDoneEvent&&t/n>.9&&(Timeline.hasThrownAlmostDoneEvent=!0,EventSystem.callEventListeners("song_almost_done_playing",player.currentVideo)),t&&n?($("#bottom .timeline-wrapper .position").html(Math.floor(t/60)+":"+(Math.floor(t%60)<10?"0":"")+Math.floor(t%60)),$("#bottom .timeline-wrapper .length").html(Math.floor(n/60)+":"+(Math.floor(n%60)<10?"0":"")+Math.floor(n%60)),$("#bottom .timeline-wrapper .slider").width(t/n*$("#bottom .timeline").width())):($("#bottom .timeline-wrapper .position").html("0:00"),$("#bottom .timeline-wrapper .length").html("0:00"),$("#bottom .timeline-wrapper .slider").width(0))},stop:function(){Timeline.updateHandle&&(clearInterval(Timeline.updateHandle),Timeline.updateHandle=null)}},EventSystem={init:function(){},listeners:{language_changed:[],song_almost_done_playing:[],flattr_click_made:[],playlists_loaded:[],player_manager_initialized:[],video_started_playing_successfully:[],video_failed_to_play:[],video_played_to_end:[],backend_paused_video:[],backend_played_video:[],video_info_fetched:[],artist_twitter_account_found:[],uploader_info_fetched:[],flattr_thing_for_twitter_account_found:[],flattr_thing_for_track_found:[],flattr_thing_for_uploader_found:[],user_profile_updated:[],video_duration_updated:[],window_resized:[]},addEventListener:function(e,t){if(!EventSystem.listeners.hasOwnProperty(e))throw'Unknown event type "'+e+'"';EventSystem.listeners[e].push(t)},callEventListeners:function(e,t){var n,r,i=EventSystem.listeners[e];for(n=0;n<i.length;n+=1)r=i[n],r(t)}},HomeScreen={$rightView:null,$spotlight:null,$recommendations:null,$playlists:null,menuItem:null,nbrOfArtists:0,init:function(){var e=HomeScreen;e.$rightView=$("#right > .home"),e.$recommendations=$("#right > .home .recommendations"),e.$playlists=$("#right > .home .playlists"),e.$spotlight=e.$rightView.find(".spotlight .inner"),e.menuItem=new MenuItem({cssClasses:["home"],title:TranslationSystem.get("Home"),$contentPane:e.$rightView,onSelected:function(){HomeScreen.show()},translatable:!0}),Menu.getGroup("misc").addMenuItem(e.menuItem),EventSystem.addEventListener("window_resized",HomeScreen.loadSpotlight)},show:function(){var e=HomeScreen;history.pushState(null,null,"/"),e.reset(),HomeScreen.loadSpotlight(),HomeScreen.loadTopPlaylists(),UserManager.isLoggedIn()&&UserManager.currentUser.lastfmUserName&&HomeScreen.loadRecommendedArtists(),$("#right > div").hide(),e.$rightView.show()},reset:function(){var e=HomeScreen;e.$recommendations.html(""),e.$playlists.html("")},loadRecommendedArtists:function(){var e=HomeScreen;Recommendations.findRecommendedArtists(function(t){console.log(t),$.each(t,function(t,n){if(n.name){var r=new ArtistSuggestion({name:n.name,imageUrl:n.image[1]["#text"],mbid:n.mbid});e.$recommendations.append(r.getSmallView()).show()}})}),e.$recommendations.parent().show()},loadTopPlaylists:function(){var e=HomeScreen;$.get("/api/toplists/playlists",function(t){$.each(t,function(t,n){var r=new Playlist(n.title,n.videos,n.remoteId,n.owner,n.isPrivate,n.followers);r.videos.length&&e.$playlists.append(PlaylistView.createSmallPlaylistView(r))}),LoadingBar.hide(),e.$playlists.parent().show()})},loadSpotlight:function(){var e=HomeScreen,t=0,n=null,r=$("#right > .home .spotlight").width()*1.15,i=88,s=3,o=0;r=r<528?528:r,o=Math.ceil(r/i)*s;if(e.nbrOfArtists>=o&&e.nbrOfArtists!==0)return;e.nbrOfArtists=o,e.$spotlight.html(""),$.getJSON("/api/external_users/top/"+o,function(t){$.each(t,function(t,n){if(!n.avatar_url)return;var r=$('<div class="item"/>'),i=$('<div class="title"/>'),s=new Image;s.onload=function(){r.css({opacity:"1"})},s.src=n.avatar_url,r.css({"background-image":"url("+n.avatar_url+")"}),r.click(function(){ExternalUserPage.load(n.type,n.username)}),i.text(n.username),r.append(i),e.$spotlight.append(r)})})}},Recommendations={$rightView:null,init:function(){this.$rightView=$("#right > .recommendations"),this.$tracklist=$("#right > .recommendations .tracklist"),this.$artistList=$("#right > .recommendations .artists")},show:function(){history.pushState(null,null,"/"),$("#right > div").hide(),Menu.deSelect(),this.$rightView.show()},reset:function(){this.$tracklist.html("").hide(),this.$artistList.html("").hide()},findSimilarTracks:function(e){var t=this,n=Utils.getArtistAndTrackNames(e);if(!n){alert("Could not extract artist and title from "+e.title);return}var r="http://ws.audioscrobbler.com/2.0?callback=?",i={method:"track.getsimilar",format:"json",limit:30,artist:n.artist,track:n.track,api_key:LASTFM_API_KEY};console.log("Looking for alternatives to",n.artist,n.track),t.reset(),LoadingBar.show(),$.getJSON(r,i,function(e){LoadingBar.hide(),console.log("response",e);if(!e.similartracks||typeof e.similartracks.track!="object"){alert("Could not find any similar tracks to "+n.artist+" - "+n.track);return}$.each(e.similartracks.track,function(e,n){if(n.mbid){var r=new Video({title:n.artist.name+" - "+n.name,mbid:n.mbid,type:"unresolved"});t.$tracklist.append(r.createListView())}})}),t.$tracklist.show(),t.show()},findRecommendedArtists:function(e){var t=this;t.reset(),LoadingBar.show(),$.getJSON("/lastfm/recommendations",{},function(t){LoadingBar.hide(),t.success?e(t.artists):console.log("Failed to load recommendations…")}),t.$artistList.show(),t.show()},findSimilarArtistsFromName:function(e){var t=this,n="http://ws.audioscrobbler.com/2.0?callback=?",r={method:"artist.getsimilar",format:"json",limit:30,artist:e,api_key:LASTFM_API_KEY};t.reset(),LoadingBar.show(),$.getJSON(n,r,function(n){LoadingBar.hide(),console.log("response",n);if(!n.similarartists||typeof n.similarartists.artist!="object"){alert("Could not find any similar artists to "+e);return}$.each(n.similarartists.artist,function(e,n){if(n.mbid){var r=new ArtistSuggestion({name:n.name,imageUrl:n.image[1]["#text"],mbid:n.mbid});t.$artistList.append(r.getSmallView())}})}),t.$artistList.show(),t.show()},findSimilarArtists:function(e){return this.findSimilarArtistsFromName(e.displayName)}},InfoPopup={init:function(){EventSystem.addEventListener("video_started_playing_successfully",InfoPopup.clearPopup),EventSystem.addEventListener("video_info_fetched",InfoPopup.loadVideo),EventSystem.addEventListener("uploader_info_fetched",InfoPopup.loadUploader),EventSystem.addEventListener("artist_twitter_account_found",InfoPopup.loadTwitter)},clearPopup:function(e){$("#video-info-popup .sections li").removeClass("found"),$("#video-info-popup .sections .content").text("Not found")},createSection:function(e){var t=$('<div class="content"></div>'),n=$('<div class="title-and-description"></div>'),r=$('<a class="subtitle" target="_blank"></a>').attr("href",e.a.link).text(e.a.text).click(e.a.callback).appendTo(n);if(e.buyLinks&&e.buyLinks.length){var i=$('<p class="buy-links"></p>'),s;for(s=0;s<e.buyLinks.length;s+=1)$("<a/>").attr("href",e.buyLinks[s]).attr("target","_blank").text(TranslationSystem.get("Buy this track")).appendTo(i),$("<br/>").appendTo(i);i.appendTo(n)}if(e.description){var o=$('<p class="description"></p>');$("<span/>").text(Utils.shorten(e.description,140)+" ").appendTo(o),e.description.length>140&&$('<a class="more" href="#"/>').text(TranslationSystem.get("More")).click(function(){o.text(e.description),$("#bottom .info .title").arrowPopup("#video-info-popup","down")}).appendTo(o),o.appendTo(n)}return n.appendTo(t),e.image&&$("<img></img>").attr("src",e.image).appendTo(t),t},loadTwitter:function(e){var t=e.split("/")[3],n="https://api.twitter.com/1/users/show.json?screen_name="+t+"&include_entities=true&callback=?",r=$("#video-info-popup .twitter");$.getJSON(n,function(n){r.addClass("found"),r.find(".content").replaceWith(InfoPopup.createSection({a:{text:"@"+t,link:e},image:n.profile_image_url,url:e}))})},loadVideo:function(e){var t=$("#video-info-popup .sections .video");t.addClass("found"),t.find(".content").replaceWith(InfoPopup.createSection({a:{text:e.title,link:e.url},description:e.description,image:e.thumbnail,buyLinks:e.buyLinks}))},loadUploader:function(e){var t=$("#video-info-popup .sections .uploader"),n;if(e.url.match("soundcloud")||e.url.match("youtube"))n=function(t){ExternalUserPage.show(e.url),t.preventDefault()};t.addClass("found"),t.find(".content").replaceWith(InfoPopup.createSection({a:{text:e.name,link:e.url,callback:n},image:e.avatar_url}))}},FlattrFinder={init:function(){EventSystem.addEventListener("video_info_fetched",FlattrFinder.findFlattrThingForTrack)},findFlattrThingForTrack:function(e){var t="https://api.flattr.com/rest/v2/things/lookup/?q="+encodeURIComponent(e.url)+"&jsonp=?";console.log("looking up flattr thing for "+e.url),e.video.flattrThingId?EventSystem.callEventListeners("flattr_thing_for_track_found",{videoTitle:e.video.title,sourceUrl:e.url,thingId:e.video.flattrThingId,flattrs:e.video.flattrs||0}):$.getJSON(t,function(t){t.message!=="not_found"&&EventSystem.callEventListeners("flattr_thing_for_track_found",{videoTitle:e.video.title,sourceUrl:e.url,thingId:t.id||null,flattrs:t.flattrs||0})})}},AutoFlattrer={thingForCurrentTrack:null,init:function(){EventSystem.addEventListener("video_started_playing_successfully",function(e){AutoFlattrer.thingForCurrentTrack=!1}),EventSystem.addEventListener("flattr_thing_for_track_found",function(e){AutoFlattrer.thingForCurrentTrack=e}),EventSystem.addEventListener("song_almost_done_playing",function(e){has_flattr_access_token&&settingsFromServer.flattr_automatically&&AutoFlattrer.thingForCurrentTrack&&AutoFlattrer.makeFlattrClick(AutoFlattrer.thingForCurrentTrack)})},makeFlattrClick:function(e){var t,n;e.thingId?(t="/flattrclick",n={videoTitle:e.videoTitle,thing_id:e.thingId}):(t="/flattrautosubmit",n={videoTitle:e.videoTitle,url:e.sourceUrl}),$.post(t,n,function(e){e===null?console.log("Error: response from Flattr was null"):e.hasOwnProperty("error_description")?console.log("Flattr error",e.error_description):EventSystem.callEventListeners("flattr_click_made",e)})}},Lastfm={init:function(){EventSystem.addEventListener("song_almost_done_playing",function(e){has_lastfm_access_token&&settingsFromServer.lastfm_scrobble_automatically&&Lastfm.scrobble(e)})},scrobble:function(e){var t=Utils.getArtistAndTrackNames(e);t?(t.timestamp=(new Date).getTime()/1e3>>0,$.post("/lastfm/scrobble",t,function(e){if(e.success){var t=e.result;console.log("Scrobbled '"+t.track["#text"]+"' by '"+t.artist["#text"]+"'")}else console.log("Failed to scrobble")})):console.log("Could not scrobble, could not find artist and title")}},EchoNest={init:function(){EventSystem.addEventListener("video_started_playing_successfully",function(e){EchoNest.fingerprint(e),EchoNest.extractArtist(e)})},extractArtist:function(e){var t={api_key:ECHONEST_API_KEY,format:"json",text:e.title,sort:"familiarity-desc",min_familiarity:"0.3",results:15};$.getJSON("http://developer.echonest.com/api/v4/artist/extract",t,function(t){t.response.artists.length===1&&(e.echonestArtist=t.response.artists[0].name,console.log("Echo Nest identified artist as '"+e.echonestArtist+"'"))})},fingerprint:function(e){if(e.type==="soundcloud"){var t={api_key:ECHONEST_API_KEY,format:"json",url:"https://api.soundcloud.com/tracks/"+e.videoId+"/stream?consumer_key="+SOUNDCLOUD_API_KEY};$.post("http://developer.echonest.com/api/v4/track/upload",t,function(t){var n=t.response;n.status.message==="Success"?n.track.status==="complete"?(e.echonestInformation=n.track,n.track.title?(e.track=n.track.title,e.artist=n.track.artist,console.log("Echo Nest identified as '"+e.track+"' by '"+e.artist+"'")):console.log("Echo Nest could not identify '"+e.title+"'")):console.log("Echo Nest failed on '"+e.title+"'"):console.log("Something failed when connecting to the Echo Nest")})}else console.log("Cannot fingerprint non-soundcloud tracks yet")}},VideoInfo={init:function(){EventSystem.addEventListener("video_started_playing_successfully",function(e){switch(e.type){case"youtube":VideoInfo.loadYouTubeVideoInfo(e);break;case"soundcloud":VideoInfo.loadSoundCloudTrackInfo(e);break;case"officialfm":VideoInfo.loadOfficialFmTrackInfo(e)}}),EventSystem.addEventListener("video_info_fetched",VideoInfo.loadLinko),EventSystem.addEventListener("video_info_fetched",function(e){switch(e.video.type){case"youtube":VideoInfo.loadYouTubeUploader(e);break;case"soundcloud":break;case"officialfm":}})},loadYouTubeUploader:function(e){var t=e.author.uri+"?callback=?",n={alt:"json-in-script",prettyprint:!0,v:2},r=e.author;$.getJSON(t,n,function(e){r.url="http://www.youtube.com/user/"+encodeURIComponent(e.entry.yt$username.$t),r.avatar_url=e.entry.media$thumbnail.url,EventSystem.callEventListeners("uploader_info_fetched",r)})},loadOfficialFmTrackInfo:function(e){var t="http://api.official.fm/track/"+e.videoId,n={format:"json",key:OFFICIALFM_API_KEY},r={video:e};$.getJSON(t,n,function(t){t=t[0],r.video.title=t.title,r.video.duration=t.length*1e3,r.url="http://official.fm/tracks/"+t.id,r.title=t.title,r.description=t.description,r.thumbnail=t.picture_absolute_url,r.author={name:t.artist_string,url:t.web_url||t.buy_url,user_id:t.user_id},r.buyLinks=e.buyLinks||t.buy_url?[t.buy_url]:null,EventSystem.callEventListeners("video_info_fetched",r),EventSystem.callEventListeners("uploader_info_fetched",r.author)})},loadSoundCloudTrackInfo:function(e){var t="http://api.soundcloud.com/tracks/"+e.videoId+".json",n={client_id:SOUNDCLOUD_API_KEY},r={video:e};$.getJSON(t,n,function(t){r.url=t.permalink_url,r.title=t.title,r.thumbnail=t.artwork_url,r.description=t.description,r.author={name:t.user.username,avatar_url:t.user.avatar_url,url:t.user.permalink_url,uri:t.user.uri},r.buyLinks=e.buyLinks||t.purchase_url?[t.purchase_url]:null,EventSystem.callEventListeners("video_info_fetched",r),EventSystem.callEventListeners("uploader_info_fetched",r.author)})},loadYouTubeVideoInfo:function(e){var t="http://gdata.youtube.com/feeds/api/videos/"+e.videoId+"?callback=?",n={alt:"json-in-script",prettyprint:!0,v:2},r=e.getExternalLink(),i={video:e,url:r.url};$.getJSON(t,n,function(e){i.author={name:e.entry.author[0].name.$t,uri:e.entry.author[0].uri.$t},i.title=e.entry.title.$t;try{i.description=e.entry.media$group.media$description.$t}catch(t){i.description=""}try{i.thumbnail=e.entry.media$group.media$thumbnail[0].url}catch(n){i.thumbnail=null}EventSystem.callEventListeners("video_info_fetched",i)})},loadLinko:function(e){var t=Utils.extractArtist(e.title);if(t){var n="http://linko.fruktsallad.net/artist/"+t.replace(/ /g,"_")+".json?callback=?";$.getJSON(n,{},function(e){if(!e||!e.links||!e.hasOwnProperty("artist_name"))return;e.links.hasOwnProperty("Twitter")&&EventSystem.callEventListeners("artist_twitter_account_found",e.links.Twitter)})}}},BottomPanel={init:function(){EventSystem.addEventListener("video_info_fetched",function(e){BottomPanel.setTitleText(e.title)}),$("#bottom .info .i").click(function(){player.currentVideo&&$(this).arrowPopup("#video-info-popup","down")}),$("#bottom .info .title").bind("contextmenu",function(e){return player.currentVideo&&showResultsItemContextMenu(e,player.currentVideo.listView),!1}),$("#bottom .controls .playpause").click(player.playPause),$("#bottom .controls .next").click(player.next),$("#bottom .controls .prev").click(player.prev),$("#bottom .fullscreen").click(function(e){$(this).toggleClass("on"),player.toggleFullScreen(e)}),$("#bottom .shuffle").click(function(){$(this).toggleClass("on"),player.currentVideo&&player.currentVideo.listView&&Queue.addSiblingsToPlayorder(player.currentVideo.listView)})},setTitleText:function(e){$("#bottom .info .i").css({display:"inline-block"}),$("#bottom .info .title").text(e).attr("title",e)}},TopMenu={hasLoadedAboutPopupHtml:!1,init:function(){UserManager.isLoggedIn()?($("#top .profile").css("background-image","url("+UserManager.currentUser.smallImageUrl+")"),$("#top .profile").click(function(e){$(this).arrowPopup("#profile-popup")}),EventSystem.addEventListener("user_profile_updated",function(e){$("#top .profile .display-name").text(e.displayName)}),$("#profile-popup .profile-page").click(function(e){UserManager.loadCurrentUser(),Utils.closeAnyOpenArrowPopup()}),$("#top .login-link").hide()):($("#top .profile").hide(),$("#top .activities").hide()),$("#top .about").click(function(){$(this).arrowPopup("#about-popup"),TopMenu.hasLoadedAboutPopupHtml||$.ajax({url:"/about",statusCode:{200:function(e){TopMenu.hasLoadedAboutPopupHtml=!0,$("#about-popup").html(e),$("#about-popup .share iframe").css("height","62px").css("width","55px")}}})}),$("#top .activities").click(function(){$(this).arrowPopup("#activities-popup"),Activities.loadNotificationsPopup()}),$("#top .settings").click(function(){$(this).arrowPopup("#settings"),SettingsPopup.markAllPuffsAsSeen()})}},UserManager={currentUser:null,viewingUser:null,tabs:null,$rightView:null,$playlists:null,$followings:null,$followers:null,$flattrs:null,$playlistsTab:null,$followingsTab:null,$followersTab:null,$flattrsTab:null,$followButton:null,$unFollowButton:null,$editButton:null,$img:null,$changePictureBox:null,init:function(e){e&&(UserManager.currentUser=new User(e),EventSystem.addEventListener("user_profile_updated",function(e){UserManager.currentUser.displayName=e.displayName,UserManager.currentUser.nickname=e.nickname,UserManager.currentUser.firstName=e.first_name,UserManager.currentUser.lastName=e.last_name,UserManager.currentUser.tagline=e.tagline,UserManager.loadCurrentUser(),history.pushState(null,null,UserManager.currentUser.getUrl())}),EventSystem.addEventListener("flattr_click_made",function(e){UserManager.currentUser.nrOfFlattrs+=1})),UserManager.$rightView=$("#right .profile"),UserManager.$playlists=$("#right .profile .pane.profile-playlists"),UserManager.$followings=$("#right .profile .pane.profile-followings"),UserManager.$followers=$("#right .profile .pane.profile-followers"),UserManager.$flattrs=$("#right .profile .pane.profile-flattrs"),UserManager.$playlistsTab=$("#right .profile .tabs .profile-playlists"),UserManager.$followingsTab=$("#right .profile .tabs .profile-followings"),UserManager.$followersTab=$("#right .profile .tabs .profile-followers"),UserManager.$flattrsTab=$("#right .profile .tabs .profile-flattrs"),UserManager.$followButton=$("#right .profile .follow.button"),UserManager.$unFollowButton=$("#right .profile .unfollow.button"),UserManager.$editButton=$("#right .profile .edit.button"),UserManager.$img=$("#right .profile .picture-container .picture"),UserManager.$changePictureBox=$("#right .profile .picture-container .change"),UserManager.tabs=new Tabs(UserManager.$rightView.find(".tab-area"),{"profile-followers":UserManager.loadFollowers,"profile-followings":UserManager.loadFollowings,"profile-flattrs":UserManager.loadFlattrs})},isLoggedIn:function(){return UserManager.currentUser!==null},show:function(){Menu.deSelect(),UserManager.tabs.select("profile-playlists"),history.pushState(null,null,UserManager.viewingUser.getUrl()),$("#right > div").hide(),UserManager.$rightView.show()},loadCurrentUser:function(){UserManager.resetUserProfileView(),UserManager.populateUserProfile(UserManager.currentUser),UserManager.show()},loadProfile:function(e){UserManager.resetUserProfileView(),LoadingBar.show(),$.ajax({type:"GET",url:"/api/users/"+e,complete:function(e,t){LoadingBar.hide()},statusCode:{200:function(e){$("#right .profile").show(),UserManager.populateUserProfile(new User(e))},404:function(t,n){alert('User "'+e+'" not found')}}})},resetUserProfileView:function(){UserManager.$followButton.hide(),UserManager.$unFollowButton.hide(),UserManager.$editButton.hide(),UserManager.$changePictureBox.text(""),UserManager.$changePictureBox.hide(),UserManager.$playlists.html(""),UserManager.$followings.html(""),UserManager.$followers.html(""),UserManager.$img&&UserManager.$img.remove(),$("#right .profile .information-container .flattr-user-name").text("").hide(),$("#right .profile .information-container .display-name").text(""),$("#right .profile .information-container .nickname").text(""),$("#right .profile .information-container .tagline").text(""),UserManager.tabs.select("profile-playlists"),$("#right .profile .tabs").hide()},populateUserProfile:function(e){UserManager.viewingUser=e;var t=e.largeImageUrl;UserManager.$img=$('<img class="picture" alt="Profile picture" />').attr("src",t).prependTo($("#right .profile .picture-container")),UserManager.$followButton.unbind("click").click(function(){$.post("/me/followings/"+e.id,function(t){UserManager.$followButton.hide(),UserManager.$unFollowButton.show(),UserManager.currentUser.nrOfFollowings+=1,e.nrOfFollowers+=1,Utils.addFollowing(e),UserManager.loadFollowers()})}),UserManager.$unFollowButton.unbind("click").click(function(){$.ajax({type:"DELETE",url:"/me/followings/"+e.id,statusCode:{200:function(t){UserManager.$followButton.show(),UserManager.$unFollowButton.hide(),UserManager.currentUser.nrOfFollowings-=1,e.nrOfFollowers-=1,Utils.removeFollowing(e.id),UserManager.loadFollowers()}}})}),UserManager.$editButton.unbind("click").click(function(){(new EditProfileDialog).show()}),UserManager.isLoggedIn()&&UserManager.currentUser.id===e.id?(e.playlists=playlistManager.playlists,UserManager.$editButton.show(),UserManager.$changePictureBox.html(TranslationSystem.get("Configure your profile picture for $email at $gravatar",{$email:UserManager.currentUser.email,$gravatar:'<a href="http://www.gravatar.com" target="_blank">gravatar.com</a>'})),UserManager.$changePictureBox.show()):UserManager.isLoggedIn()&&Utils.isFollowingUser(e.id)?UserManager.$unFollowButton.show():UserManager.isLoggedIn()&&UserManager.$followButton.show(),e.flattrUserName&&$("#right .profile .information-container .flattr-user-name").text(e.flattrUserName).attr("href","http://flattr.com/profile/"+e.flattrUserName).show(),$("#right .profile .information-container .display-name").text(e.displayName),$("#right .profile .information-container .nickname").text(e.nickname),$("#right .profile .information-container .tagline").text(e.tagline),UserManager.updatePlaylistsTabLabel(e.nrOfPlaylists),UserManager.updateFollowersTabLabel(e.nrOfFollowers),UserManager.updateFollowingsTabLabel(e.nrOfFollowings),UserManager.updateFlattrsTabLabel(e.nrOfFlattrs),UserManager.isLoggedIn()&&UserManager.currentUser.id===e.id?$.each(playlistManager.playlists,function(e,t){var n=new Playlist(t.title,t.videos,t.remoteId,t.owner,t.isPrivate,t.followers);n.videos.length&&UserManager.$playlists.append(PlaylistView.createSmallPlaylistView(n,!0))}):UserManager.loadPlaylists(),$("#right .profile .tabs").show()},updateFollowersTabLabel:function(e){UserManager.$followersTab.text(TranslationSystem.get("Followers")+" ("+e+")")},updateFollowingsTabLabel:function(e){UserManager.$followingsTab.text(TranslationSystem.get("Following")+" ("+e+")")},updatePlaylistsTabLabel:function(e){UserManager.$playlistsTab.text(TranslationSystem.get("Playlists")+" ("+e+")")},updateFlattrsTabLabel:function(e){UserManager.$flattrsTab.text(TranslationSystem.get("Flattrs")+" ("+e+")")},loadPlaylists:function(){LoadingBar.show(),$.getJSON("/api/users/"+UserManager.viewingUser.id+"/playlists",function(e){$.each(e,function(e,t){var n=new Playlist(t.title,t.videos,t.remoteId,t.owner,t.isPrivate,t.followers);n.videos.length&&UserManager.$playlists.append(PlaylistView.createSmallPlaylistView(n))}),LoadingBar.hide()})},loadFollowers:function(){$.getJSON("/api/users/"+UserManager.viewingUser.id+"/followers",function(e){UserManager.$followers.html(""),UserManager.updateFollowersTabLabel(e.length),$.each(e,function(e,t){UserManager.$followers.append((new User(t)).getSmallView())})})},loadFollowings:function(){$.getJSON("/api/users/"+UserManager.viewingUser.id+"/followings",function(e){UserManager.$followings.html(""),UserManager.updateFollowingsTabLabel(e.length),$.each(e,function(e,t){UserManager.$followings.append((new User(t)).getSmallView())})})},loadFlattrs:function(){$.getJSON("/api/users/"+UserManager.viewingUser.id+"/activities?verbs=flattr&type=outgoing",function(e){UserManager.$flattrs.html(""),UserManager.updateFlattrsTabLabel(e.length),$.each(e,function(e,t){var n=JSON.parse(t.target);UserManager.$flattrs.append(NewsFeed.getIncomingFlattrActivity(UserManager.viewingUser,n))})})},findUser:function(e,t){$.getJSON("/api/users/"+e,function(e){t(e)})}},ExternalUserPage={$view:null,$subscribeButton:null,$unsubscribeButton:null,externalUser:null,init:function(){var e=this;e.$view=$("#right > div.external-profile"),e.$subscribeButton=e.$view.find(".button.subscribe"),e.$unsubscribeButton=e.$view.find(".button.unsubscribe"),e.$subscribeButton.click(function(){ExternalUserSubscriptions.subscribe(e.externalUser,function(){e.$subscribeButton.hide().next().show()})}),e.$unsubscribeButton.click(function(){ExternalUserSubscriptions.unsubscribe(e.externalUser,function(){e.$unsubscribeButton.hide().prev().show()})}),e.$view.find(".recommendations").click(function(){Recommendations.findSimilarArtists(e.externalUser)})},setMenuItemAsPlayingFor:function(e,t){var n=Menu.getGroup("external-user-subscriptions");$.each(n.menuItems,function(n,r){r.$view.hasClass(e)&&r.$view.text()===t&&r.setAsPlaying()})},showView:function(){$("#right > div").hide().removeClass("selected"),this.$view.show()},resetView:function(){this.$view.find("h1").html(""),this.$view.find(".source").attr("href","#").html(""),this.$view.find(".img").html(""),this.$view.find(".description").html(""),this.$view.find(".tracklist").hide(),this.$view.find(".button.subscribe").hide(),this.$view.find(".button.unsubscribe").hide()},show:function(e){var t,n,r;t=e.match("/soundcloud.com/(.*)"),t&&(n="soundcloud",r=t[1]),t=e.match("youtube.com/user/(.*)"),t&&(n="youtube",r=t[1]),this.load(n,r)},load:function(e,t){switch(e){case"soundcloud":this.loadSoundCloudUser(t);break;case"youtube":this.loadYouTubeUser(t);break;default:console.log("Unknown type for external users: "+e)}},loadSoundCloudUser:function(e){var t=this;this.resetView(),this.showView(),history.pushState(null,null,"/soundcloud/"+e),$.getJSON("http://api.soundcloud.com/resolve.json?callback=?",{client_id:SOUNDCLOUD_API_KEY,url:"https://soundcloud.com/"+e},function(n){$.getJSON("http://api.soundcloud.com/users/"+n.id+".json",{client_id:SOUNDCLOUD_API_KEY},function(n){t.externalUser=new ExternalUserSubscription({type:"soundcloud",external_user_id:String(n.id),username:e,display_name:n.username,avatar_url:n.avatar_url}),UserManager.isLoggedIn()&&(ExternalUserSubscriptions.isSubscription(t.externalUser)?t.$unsubscribeButton.show():t.$subscribeButton.show()),t.$view.find("h1").text(n.username),t.$view.find(".source").text(TranslationSystem.get("View on SoundCloud")).attr("href",n.permalink_url),t.$view.find(".img").append($('<img src="'+n.avatar_url+'"/>')),t.$view.find(".description").text(Utils.shorten(n.description,500))});var r="soundcloud"+e,i=t.$view.find("#"+r);i.length?i.show():$.getJSON("http://api.soundcloud.com/users/"+n.id+"/tracks.json",{client_id:SOUNDCLOUD_API_KEY},function(n){var i=Search.getVideosFromSoundCloudSearchData(n),s=$('<table class="tracklist"></table>').attr("id",r);$.each(i,function(n,r){r.onPlayCallback=function(){t.setMenuItemAsPlayingFor("soundcloud",e)},r.createListView().appendTo(s)}),s.appendTo(t.$view)})})},loadYouTubeUser:function(e){var t=this;t.resetView(),t.showView(),history.pushState(null,null,"/youtube/"+e),$.getJSON("https://gdata.youtube.com/feeds/api/users/"+e+"?callback=?",{alt:"json-in-script",v:2},function(n){t.externalUser=new ExternalUserSubscription({type:"youtube",external_user_id:e,username:e,display_name:n.entry.author[0].name.$t,avatar_url:n.entry.media$thumbnail.url}),UserManager.isLoggedIn()&&(ExternalUserSubscriptions.isSubscription(t.externalUser)?t.$unsubscribeButton.show():t.$subscribeButton.show()),t.$view.find("h1").text(n.entry.author[0].name.$t),t.$view.find(".source").text(TranslationSystem.get("View on YouTube")).attr("href","http://www.youtube.com/user/"+e),t.$view.find(".img").append($('<img src="'+t.externalUser.avatarUrl+'"/>')),t.$view.find(".description").text(n.entry.summary.$t)});var n="youtube"+e,r=t.$view.find("#"+n);r.length?r.show():$.getJSON("https://gdata.youtube.com/feeds/api/users/"+e+"/uploads?callback=?",{alt:"json-in-script",v:2},function(r){if(r.feed.entry===undefined)return;var i=Search.getVideosFromYouTubeSearchData(r),s=$('<table class="tracklist"></table>').attr("id",n);$.each(i,function(n,r){r.onPlayCallback=function(){t.setMenuItemAsPlayingFor("youtube",e)},r.createListView().appendTo(s)}),s.appendTo(t.$view)})}},ExternalUserSubscriptions={subscriptions:[],init:function(){var e=this;UserManager.isLoggedIn()&&$.getJSON("/me/external_user_subscriptions",function(t){$.each(t,function(t,n){e.subscriptions.push(new ExternalUserSubscription(n))}),e.updateMenu()})},updateMenu:function(){var e=this,t=Menu.getGroup("external-user-subscriptions");t.clear(),$.each(e.subscriptions,function(e,n){t.addMenuItem(n.getMenuItem())})},isSubscription:function(e){var t=!1;return $.each(this.subscriptions,function(n,r){if(e.equals(r)){t=!0;return}}),t},subscribe:function(e,t){var n=this;LoadingBar.show(),$.ajax({type:"POST",url:e.getApiUrl(),data:e.getMetaData(),complete:function(e,t){LoadingBar.hide()},statusCode:{200:function(r){n.subscriptions.push(e),n.updateMenu(),t()},409:function(e){(new ReloadDialog).show()}}})},unsubscribe:function(e,t){var n=this;LoadingBar.show(),$.ajax({type:"DELETE",url:e.getApiUrl(),complete:function(e,t){LoadingBar.hide()},statusCode:{200:function(r){var i=[];$.each(n.subscriptions,function(t,n){e.equals(n)||i.push(n)}),n.subscriptions=i,n.updateMenu(),t()},409:function(e){(new ReloadDialog).show()}}})}};ModalBox.prototype.setCanBeClosed=function(e){self=this,e&&($('<span class="close">X</span>').click(function(){self.remove()}).appendTo(self.view.find(".top")),this.view.click(function(t){$(t.target).hasClass("modalbox")&&e&&self.remove()}))},ModalBox.prototype.setMessage=function(e){this.view.find(".wrapper p").text(e)},ModalBox.prototype.addButton=function(e,t,n){var r=this,i=$('<button class="button"></button>').text(e);n&&i.addClass(n),i.click(function(){t(r)}),this.view.find(".buttons").append(i)},ModalBox.prototype.show=function(){$("body").append(this.view)},ModalBox.prototype.remove=function(){this.view.remove()},ReloadDialog.prototype=new ModalBox,ReloadDialog.prototype.constructor=ReloadDialog,EditProfileDialog.prototype=new ModalBox,EditProfileDialog.prototype.constructor=EditProfileDialog,ShareTrackDialog.prototype=new ModalBox,ShareTrackDialog.prototype.constructor=ShareTrackDialog,AddToPlaylistDialog.prototype=new ModalBox,AddToPlaylistDialog.prototype.constructor=AddToPlaylistDialog;var LayoutManager={self:this,width:0,height:0,init:function(){self.width=$(window).width(),self.height=$(window).height(),$("#left .menu > li").click(function(){self.width<=320&&$("body").animate({scrollLeft:self.width},200)})}};Logo={init:function(){var e=$("#top .logo");e.click(function(e){$("#left .menu .home").mousedown()}),e.bind("contextmenu",function(t){return LoadingBar.show(),$.get("/logo",function(e){$("#logo-popup").html(e)}),e.arrowPopup("#logo-popup","up"),LoadingBar.hide(),!1})}};var WindowEvents={windowResizedHandler:null,init:function(){$(window).resize(function(){WindowEvents.windowResizedHandler!==null&&window.clearTimeout(WindowEvents.windowResizedHandler),WindowEvents.windowResizedHandler=window.setTimeout(WindowEvents.windowResized,500)})},windowResized:function(){EventSystem.callEventListeners("window_resized",{width:$(window).width(),height:$(window).height()})}},playlistManager,youTubeApiReady=!1,player=null,ECHONEST_API_KEY="GWFNOCZP6DVXYN4RT",SOUNDCLOUD_API_KEY="206f38d9623048d6de0ef3a89fea1c4d",OFFICIALFM_API_KEY="gLc8fHvg39ez6EAYvxFA",LASTFM_API_KEY="b25b959554ed76058ac220b7b2e0a026",selectedVideoElements=[],settingsFromServer={},device,languagesFromServer,autoDetectedLanguageByServer,autoDetectedTranslations,ON_PRODUCTION,myFollowers,myFollowings;window.API_HOST===undefined&&(window.API_HOST=""),soundManager.url="/scripts/swf/",soundManager.flashVersion=9,soundManager.debugMode=!1,$(document).ajaxError(function(e,t,n,r){t.status===500&&$.trim(t.responseText).length>0&&(ON_PRODUCTION?Notifications.append("Connection error! <i>"+t.responseText+"</i>"):$("body").html(t.responseText)),LoadingBar.error()}),$(document).ready(function(){EventSystem.init(),Menu.init(),LoadingBar.init(),WindowEvents.init(),Logo.init(),LayoutManager.init(),$.getJSON(API_HOST+"/api/main",function(e){settingsFromServer=e.settingsFromServer,device=e.device,languagesFromServer=e.languagesFromServer,autoDetectedLanguageByServer=e.autoDetectedLanguageByServer,autoDetectedTranslations=e.autoDetectedTranslations,ON_PRODUCTION=e.ON_PRODUCTION,myFollowers=e.myFollowers,myFollowings=e.myFollowings,UserManager.init(e.user),TopMenu.init(),$("body").addClass("loaded"),$("#top .login-link").attr("href",e.loginUrl),$("#profile-popup .logout a").attr("href",e.logoutUrl),playlistManager=new PlaylistsManager,Volume.init(),TranslationSystem.init(),SpotifyImporterPopup.init(),SettingsPopup.init(),Search.init(),HomeScreen.init(),Queue.init(),Ping.init(),Notifications.init(),player=new PlayerManager,player.init(),Timeline.init(),InfoPopup.init(),VideoInfo.init(),Recommendations.init(),FlattrFinder.init(),AutoFlattrer.init(),Lastfm.init(),EchoNest.init(),BottomPanel.init(),ExternalUserPage.init(),ExternalUserSubscriptions.init(),URIManager.init()}),$(".login-link").click(LoadingBar.show),$(".playlists").click(function(e){$(e.target).hasClass("playlists")&&Utils.deSelectSelectedVideos()})})
